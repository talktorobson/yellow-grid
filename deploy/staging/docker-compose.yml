# Staging Environment - Yellow Grid
# Separate from production for safe testing
# Deploy: docker compose -f docker-compose.yml up -d

services:
  # PostgreSQL Database (staging data, can be reset)
  postgres:
    image: postgres:15
    container_name: staging-postgres
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-staging_password}
      POSTGRES_DB: yellow_grid_staging
    volumes:
      - staging_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres']
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: staging-redis
    restart: always
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5

  # Elasticsearch for Camunda (memory-optimized)
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.9.1
    container_name: staging-elasticsearch
    restart: always
    environment:
      - discovery.type=single-node
      - cluster.name=staging-es
      - xpack.security.enabled=false
      - xpack.ml.enabled=false
      - ES_JAVA_OPTS=-Xms256m -Xmx256m
    volumes:
      - staging_elasticsearch_data:/usr/share/elasticsearch/data
    healthcheck:
      test: ['CMD-SHELL', 'curl -sf http://localhost:9200/_cluster/health || exit 1']
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 512M

  # Zeebe - Workflow Engine
  zeebe:
    image: camunda/zeebe:8.5.0
    container_name: staging-zeebe
    restart: always
    environment:
      - ZEEBE_BROKER_EXPORTERS_ELASTICSEARCH_CLASSNAME=io.camunda.zeebe.exporter.ElasticsearchExporter
      - ZEEBE_BROKER_EXPORTERS_ELASTICSEARCH_ARGS_URL=http://elasticsearch:9200
      - JAVA_TOOL_OPTIONS=-Xms256m -Xmx256m
      - ZEEBE_BROKER_CLUSTER_PARTITIONSCOUNT=1
    volumes:
      - staging_zeebe_data:/usr/local/zeebe/data
    depends_on:
      elasticsearch:
        condition: service_healthy
    healthcheck:
      test: ['CMD-SHELL', 'timeout 5 bash -c "</dev/tcp/localhost/26500" 2>/dev/null || exit 1']
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 120s
    deploy:
      resources:
        limits:
          memory: 512M

  # Camunda Operate (optional - can be disabled to save resources)
  operate:
    image: camunda/operate:8.5.0
    container_name: staging-operate
    restart: always
    profiles: ['camunda-ui']  # Only starts with: docker compose --profile camunda-ui up
    environment:
      - CAMUNDA_OPERATE_ZEEBE_GATEWAYADDRESS=zeebe:26500
      - CAMUNDA_OPERATE_ELASTICSEARCH_URL=http://elasticsearch:9200
      - JAVA_TOOL_OPTIONS=-Xms128m -Xmx128m
      - CAMUNDA_OPERATE_AUTH_TYPE=simple
      - CAMUNDA_OPERATE_USERID=demo
      - CAMUNDA_OPERATE_PASSWORD=demo
    depends_on:
      zeebe:
        condition: service_started
      elasticsearch:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 256M

  # Backend API
  api:
    build:
      context: ../..
      dockerfile: Dockerfile
    container_name: staging-api
    restart: always
    environment:
      - NODE_ENV=staging
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD:-staging_password}@postgres:5432/yellow_grid_staging?schema=public
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET:-staging-jwt-secret-change-me}
      - ZEEBE_ADDRESS=zeebe:26500
      - ZEEBE_INSECURE=true
      - CAMUNDA_ENABLED=true
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      zeebe:
        condition: service_started
    healthcheck:
      test: ['CMD-SHELL', 'curl -sf http://localhost:3000/api/v1/health || exit 1']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 512M

  # Frontend (Caddy + React SPA)
  frontend:
    image: caddy:2-alpine
    container_name: staging-frontend
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile.staging:/etc/caddy/Caddyfile
      - ../../web/dist:/srv:ro
      - staging_caddy_data:/data
      - staging_caddy_config:/config
    depends_on:
      - api

volumes:
  staging_postgres_data:
  staging_elasticsearch_data:
  staging_zeebe_data:
  staging_caddy_data:
  staging_caddy_config:
