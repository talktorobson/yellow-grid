name: Preview Deployment

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '20'

jobs:
  # ============================================================
  # Deploy Preview Environment for PRs
  # ============================================================
  deploy-preview:
    name: ðŸ”® Deploy Preview
    runs-on: ubuntu-latest
    environment:
      name: preview-${{ github.event.pull_request.number }}
      url: https://pr-${{ github.event.pull_request.number }}.staging.goexec.de
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install & Build
        run: |
          npm ci
          npx prisma generate
          npm run build
          cd web && npm ci && npm run build
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.STAGING_SSH_KEY }}" > ~/.ssh/staging_key
          chmod 600 ~/.ssh/staging_key
          ssh-keyscan -H ${{ secrets.STAGING_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy Preview
        env:
          SSH_HOST: ${{ secrets.STAGING_HOST }}
          SSH_USER: ${{ secrets.STAGING_USER }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # Create preview namespace on staging
          ssh -i ~/.ssh/staging_key ${SSH_USER}@${SSH_HOST} << EOF
            # Create preview directory
            mkdir -p /root/previews/pr-${PR_NUMBER}
            
            # Note: In a real setup, you'd use Docker Compose with
            # project name to create isolated preview environments
            echo "Preview PR-${PR_NUMBER} would be deployed here"
            echo "For now, use staging.goexec.de for testing"
          EOF
      
      - name: Comment PR with Preview URL
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ”® Preview Deployment
              
              Your changes are ready for testing!
              
              | Environment | URL |
              |-------------|-----|
              | Staging | https://staging.goexec.de |
              | API Docs | https://staging.goexec.de/api/docs |
              
              **Test Credentials:** \`operator.fr@adeo.com\` / \`Admin123!\`
              
              > This preview uses the shared staging environment. For isolated previews, consider upgrading to a larger staging VPS.`
            })
