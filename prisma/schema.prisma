// Yellow Grid Platform - Prisma Schema
// Architecture: Single schema with application-level multi-tenancy

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// IDENTITY & ACCESS MODULE
// ============================================================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String?  // bcrypt hashed (nullable for future SSO-only users)
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  phone     String?

  // Multi-tenancy (application-level)
  countryCode String @map("country_code") @db.VarChar(3) // ES, FR, IT, PL
  businessUnit String @map("business_unit") @db.VarChar(50) // LM_ES, BD_FR

  // User classification and auth method
  userType     UserType @default(INTERNAL) @map("user_type")
  authProvider String   @default("local") @map("auth_provider") @db.VarChar(20) // local, sso, auth0
  externalAuthId String? @unique @map("external_auth_id") // For future Auth0 migration

  // Provider linkage (only for EXTERNAL users)
  providerId   String? @map("provider_id")
  provider     Provider? @relation(fields: [providerId], references: [id])

  workTeamId   String? @map("work_team_id")
  workTeam     WorkTeam? @relation(fields: [workTeamId], references: [id])

  // Account status
  isActive  Boolean  @default(true) @map("is_active")
  isVerified Boolean @default(false) @map("is_verified")

  // Multi-factor authentication
  mfaEnabled Boolean @default(false) @map("mfa_enabled")
  mfaSecret  String? @map("mfa_secret") // Encrypted TOTP secret

  // Roles & Permissions
  roles         UserRole[]
  refreshTokens RefreshToken[]
  devices       RegisteredDevice[]

  // Project ownership (Phase 2)
  pilotedProjects Project[] @relation("ProjectPilot")

  // Audit
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  lastLoginAt DateTime? @map("last_login_at")

  @@index([email])
  @@index([userType])
  @@index([countryCode, businessUnit])
  @@index([providerId])
  @@index([workTeamId])
  @@map("users")
}

enum UserType {
  INTERNAL             // Operators, admins, managers
  EXTERNAL_PROVIDER    // Provider company users (managers)
  EXTERNAL_TECHNICIAN  // Field technicians
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique // OPERATOR, ADMIN, PROVIDER_MANAGER, TECHNICIAN
  description String?
  permissions RolePermission[]
  users       UserRole[]

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid())
  resource    String   // service_orders, providers, assignments
  action      String   // create, read, update, delete, assign
  description String?

  roles       RolePermission[]

  @@unique([resource, action])
  @@map("permissions")
}

// Junction tables
model UserRole {
  userId String @map("user_id")
  roleId String @map("role_id")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

model RolePermission {
  roleId       String @map("role_id")
  permissionId String @map("permission_id")

  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  isRevoked Boolean  @default(false) @map("is_revoked")

  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// Device registration for biometric authentication (technicians)
model RegisteredDevice {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  deviceId   String   @unique @map("device_id")
  publicKey  String   @map("public_key") @db.Text // For biometric challenge-response
  platform   String   @db.VarChar(20) // ios, android
  deviceName String   @map("device_name") @db.VarChar(255)
  deviceModel String? @map("device_model") @db.VarChar(100)

  isActive   Boolean  @default(true) @map("is_active")

  lastLoginAt DateTime? @map("last_login_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([deviceId])
  @@index([isActive])
  @@map("registered_devices")
}

// ============================================================================
// CONFIGURATION MODULE
// ============================================================================

model SystemConfig {
  id    String @id @default(uuid())
  key   String @unique
  value Json

  description String?

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("system_config")
}

model CountryConfig {
  countryCode String @id @map("country_code") @db.VarChar(3) // ES, FR, IT, PL

  // Regional settings
  timezone    String @db.VarChar(50) // Europe/Madrid, Europe/Paris
  currency    String @db.VarChar(3) // EUR
  locale      String @db.VarChar(10) // es-ES, fr-FR

  // Working days
  workingDays Json // ["MON", "TUE", "WED", "THU", "FRI"]

  // Buffers (global defaults)
  globalBufferDays  Int @default(2) @map("global_buffer_days")
  staticBufferDays  Int @default(1) @map("static_buffer_days")

  // Assignment settings
  autoAccept  Boolean @default(false) @map("auto_accept") // ES/IT = true

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("country_config")
}

model BusinessUnitConfig {
  id           String @id @default(uuid())
  businessUnit String @unique @map("business_unit") @db.VarChar(50) // LM_ES
  countryCode  String @map("country_code") @db.VarChar(3)

  name         String @db.VarChar(255)
  isActive     Boolean @default(true) @map("is_active")

  // Contact
  email        String?
  phone        String?

  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([countryCode])
  @@map("business_unit_config")
}

// ============================================================================
// PROVIDER & CAPACITY MODULE
// ============================================================================

model Provider {
  id          String @id @default(uuid())
  externalId  String? @unique @map("external_id") // SAP ID

  // Multi-tenancy
  countryCode String @map("country_code") @db.VarChar(3)
  businessUnit String @map("business_unit") @db.VarChar(50)

  // Basic info
  name        String @db.VarChar(255)
  legalName   String @map("legal_name") @db.VarChar(255)
  taxId       String? @map("tax_id") @db.VarChar(50)

  // Contact
  email       String?
  phone       String?
  address     Json? // {street, city, postalCode, country}

  // Status
  status      ProviderStatus @default(ACTIVE)

  // Relations
  workTeams   WorkTeam[]
  users       User[] // Provider managers/admins

  // Phase 2 relations
  serviceOrders ServiceOrder[]
  assignments   Assignment[]
  bookings      Booking[]

  // Audit
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([countryCode, businessUnit])
  @@index([status])
  @@map("providers")
}

enum ProviderStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

model WorkTeam {
  id         String @id @default(uuid())
  providerId String @map("provider_id")

  // Multi-tenancy (inherited from provider)
  countryCode String @map("country_code") @db.VarChar(3)

  name       String @db.VarChar(255)

  // Capacity
  maxDailyJobs Int @default(5) @map("max_daily_jobs")

  // Skills (DEPRECATED - will be migrated to ProviderSpecialtyAssignment)
  skills     Json // ["installation", "repair", "tv"]
  serviceTypes Json @map("service_types") // ["P1", "P2"]

  // Geographic coverage
  postalCodes Json @map("postal_codes") // ["28001", "28002", ...]

  // Relations
  provider    Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  technicians Technician[]
  users       User[] // Technician users

  // Structured specialties (replaces JSON skills)
  specialtyAssignments ProviderSpecialtyAssignment[]

  // Phase 2 relations
  serviceOrders ServiceOrder[]
  assignments   Assignment[]
  bookings      Booking[]

  // Calendar
  workingDays Json @map("working_days") // ["MON", "TUE", ...]
  shifts      Json // [{code:"M", startLocal:"08:00", endLocal:"13:00"}]

  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@index([providerId])
  @@index([countryCode])
  @@map("work_teams")
}

model Technician {
  id         String @id @default(uuid())
  workTeamId String @map("work_team_id")

  firstName  String @map("first_name") @db.VarChar(255)
  lastName   String @map("last_name") @db.VarChar(255)

  email      String?
  phone      String

  isActive   Boolean @default(true) @map("is_active")

  // Relations
  workTeam   WorkTeam @relation(fields: [workTeamId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@index([workTeamId])
  @@map("technicians")
}

// ============================================================================
// EVENT OUTBOX (for exactly-once event publishing)
// ============================================================================

model EventOutbox {
  id            String   @id @default(uuid())
  aggregateType String   @map("aggregate_type") @db.VarChar(50)
  aggregateId   String   @map("aggregate_id") @db.VarChar(100)
  eventType     String   @map("event_type") @db.VarChar(100)
  payload       Json
  status        EventStatus @default(PENDING)

  createdAt     DateTime @default(now()) @map("created_at")
  publishedAt   DateTime? @map("published_at")

  @@index([status, createdAt])
  @@map("event_outbox")
}

enum EventStatus {
  PENDING
  PUBLISHED
  FAILED
}

// ============================================================================
// SERVICE & PROVIDER REFERENTIAL MODULE
// ============================================================================

// ----------------------------------------------------------------------------
// GEOGRAPHIC MASTER DATA (3-level hierarchy)
// ----------------------------------------------------------------------------

model Country {
  id          String   @id @default(uuid())
  code        String   @unique @db.VarChar(3) // ES, FR, IT, PL
  name        String   @db.VarChar(100)

  // Regional settings
  timezone    String   @db.VarChar(50) // Europe/Madrid, Europe/Paris
  currency    String   @db.VarChar(3)  // EUR
  locale      String   @db.VarChar(10) // es-ES, fr-FR

  // Relations
  provinces   Province[]

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("countries")
}

model Province {
  id          String   @id @default(uuid())
  countryCode String   @map("country_code") @db.VarChar(3)
  code        String   @db.VarChar(10) // 28 (Madrid), 75 (Paris)
  name        String   @db.VarChar(100)

  // Relations
  country     Country  @relation(fields: [countryCode], references: [code], onDelete: Cascade)
  cities      City[]

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([countryCode, code])
  @@index([countryCode])
  @@map("provinces")
}

model City {
  id         String   @id @default(uuid())
  provinceId String   @map("province_id")
  code       String   @db.VarChar(20) // INE/INSEE codes
  name       String   @db.VarChar(100)

  // Relations
  province    Province     @relation(fields: [provinceId], references: [id], onDelete: Cascade)
  postalCodes PostalCode[]

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([provinceId, code])
  @@index([provinceId])
  @@map("cities")
}

model PostalCode {
  id     String @id @default(uuid())
  cityId String @map("city_id")
  code   String @db.VarChar(10) // 28001, 75001, etc.

  // Relations
  city            City             @relation(fields: [cityId], references: [id], onDelete: Cascade)
  servicePricing  ServicePricing[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([cityId, code])
  @@index([code]) // Fast postal code lookup
  @@index([cityId])
  @@map("postal_codes")
}

// ----------------------------------------------------------------------------
// SERVICE CATALOG DOMAIN
// ----------------------------------------------------------------------------

model ServiceCatalog {
  id                  String        @id @default(uuid())

  // External sync tracking
  externalServiceCode String        @unique @map("external_service_code") @db.VarChar(100) // PYX_ES_HVAC_00123
  fsmServiceCode      String        @unique @map("fsm_service_code") @db.VarChar(50) // SVC_ES_001
  externalSource      String        @map("external_source") @db.VarChar(20) // PYXIS, TEMPO, SAP, FSM_CUSTOM

  // Multi-tenancy
  countryCode         String        @map("country_code") @db.VarChar(3)
  businessUnit        String        @map("business_unit") @db.VarChar(50)

  // Basic attributes
  serviceType         ServiceType   @map("service_type")
  serviceCategory     ServiceCategory @map("service_category")
  name                String        @db.VarChar(255)
  description         String?       @db.Text

  // Scope definition
  scopeIncluded       Json          @map("scope_included")  // ["Remove old unit", "Install new unit"]
  scopeExcluded       Json          @map("scope_excluded")  // ["Wall modifications"]
  worksiteRequirements Json         @map("worksite_requirements") // ["Electrical outlet within 2m"]
  productPrerequisites Json         @map("product_prerequisites") // ["HVAC unit pre-delivered"]

  // Operational settings
  estimatedDurationMinutes Int      @map("estimated_duration_minutes")
  requiresPreServiceContract Boolean @default(false) @map("requires_pre_service_contract")
  requiresPostServiceWCF    Boolean @default(true) @map("requires_post_service_wcf")
  contractTemplateId        String? @map("contract_template_id")

  // Status
  status              ServiceStatus @default(CREATED)
  deprecatedAt        DateTime?     @map("deprecated_at")
  deprecationReason   String?       @map("deprecation_reason") @db.Text

  // Sync metadata
  syncChecksum        String        @map("sync_checksum") @db.VarChar(64) // SHA256
  lastSyncedAt        DateTime?     @map("last_synced_at")

  // Relations
  contractTemplate    ContractTemplate?        @relation(fields: [contractTemplateId], references: [id], onDelete: SetNull)
  pricing             ServicePricing[]
  skillRequirements   ServiceSkillRequirement[]
  specialtyMappings   SpecialtyServiceMapping[]

  // Phase 2 relations
  serviceOrders       ServiceOrder[]

  // Audit
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")
  createdBy           String?       @map("created_by") @db.VarChar(100) // SYNC_JOB, user email
  updatedBy           String?       @map("updated_by") @db.VarChar(100)

  @@index([countryCode, businessUnit])
  @@index([serviceType])
  @@index([serviceCategory])
  @@index([status])
  @@index([externalSource])
  @@map("service_catalog")
}

enum ServiceType {
  INSTALLATION
  CONFIRMATION_TV
  QUOTATION_TV
  MAINTENANCE
  REWORK
  COMPLEX
}

enum ServiceCategory {
  HVAC              // Heating, Ventilation, Air Conditioning
  PLUMBING          // Plumbing installations
  ELECTRICAL        // Electrical work
  KITCHEN           // Kitchen installations
  BATHROOM          // Bathroom installations
  FLOORING          // Flooring installations
  WINDOWS_DOORS     // Windows and doors
  GARDEN            // Garden installations
  FURNITURE         // Furniture assembly
  OTHER             // Miscellaneous
}

enum ServiceStatus {
  CREATED           // Initial creation
  ACTIVE            // Ready for use
  DEPRECATED        // No longer offered (but historical orders remain)
  ARCHIVED          // Fully archived
}

// Regional pricing with postal code granularity
model ServicePricing {
  id           String   @id @default(uuid())
  serviceId    String   @map("service_id")

  // Multi-tenancy
  countryCode  String   @map("country_code") @db.VarChar(3)
  businessUnit String   @map("business_unit") @db.VarChar(50)

  // Geographic scope (NULL postal code = country default)
  postalCodeId String?  @map("postal_code_id")

  // Pricing
  baseRate     Decimal  @map("base_rate") @db.Decimal(10, 2) // Base hourly/fixed rate
  currency     String   @db.VarChar(3) // EUR
  rateType     RateType @map("rate_type") // HOURLY, FIXED

  // Multipliers (defaults if not specified)
  overtimeMultiplier  Decimal @default(1.5) @map("overtime_multiplier") @db.Decimal(3, 2)
  weekendMultiplier   Decimal @default(1.3) @map("weekend_multiplier") @db.Decimal(3, 2)
  holidayMultiplier   Decimal @default(1.5) @map("holiday_multiplier") @db.Decimal(3, 2)
  urgentMultiplier    Decimal @default(1.2) @map("urgent_multiplier") @db.Decimal(3, 2)

  // Validity
  validFrom    DateTime @map("valid_from")
  validUntil   DateTime? @map("valid_until")

  // Relations
  service      ServiceCatalog @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  postalCode   PostalCode?    @relation(fields: [postalCodeId], references: [id], onDelete: SetNull)

  // Audit
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  createdBy    String?  @map("created_by") @db.VarChar(100)
  updatedBy    String?  @map("updated_by") @db.VarChar(100)

  @@unique([serviceId, countryCode, businessUnit, postalCodeId, validFrom])
  @@index([serviceId])
  @@index([countryCode, businessUnit])
  @@index([postalCodeId])
  @@index([validFrom, validUntil])
  @@map("service_pricing")
}

enum RateType {
  HOURLY
  FIXED
}

// Service-to-Skill mappings (required skills for a service)
model ServiceSkillRequirement {
  id               String  @id @default(uuid())
  serviceId        String  @map("service_id")
  specialtyId      String  @map("specialty_id")

  // Requirement details
  isRequired       Boolean @default(true) @map("is_required") // vs. NICE_TO_HAVE
  minimumExperience ExperienceLevel @map("minimum_experience")

  // Relations
  service          ServiceCatalog    @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  specialty        ProviderSpecialty @relation(fields: [specialtyId], references: [id], onDelete: Cascade)

  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@unique([serviceId, specialtyId])
  @@index([serviceId])
  @@index([specialtyId])
  @@map("service_skill_requirements")
}

// ----------------------------------------------------------------------------
// PROVIDER SPECIALTY MODEL (structured capabilities)
// ----------------------------------------------------------------------------

model ProviderSpecialty {
  id          String   @id @default(uuid())
  code        String   @unique @db.VarChar(50) // HVAC_INSTALL, PLUMBING_REPAIR
  name        String   @db.VarChar(100)
  description String?  @db.Text
  category    ServiceCategory // Maps to service categories

  // Certification requirements
  requiresCertification Boolean @default(false) @map("requires_certification")
  certificationAuthority String? @map("certification_authority") @db.VarChar(100)

  // Relations
  serviceRequirements ServiceSkillRequirement[]
  serviceMappings     SpecialtyServiceMapping[]
  providerAssignments ProviderSpecialtyAssignment[]

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([category])
  @@map("provider_specialties")
}

enum ExperienceLevel {
  JUNIOR        // 0-2 years
  INTERMEDIATE  // 2-5 years
  SENIOR        // 5-10 years
  EXPERT        // 10+ years
}

// Many-to-many mapping (Provider Specialty â†” Service Catalog)
model SpecialtyServiceMapping {
  id          String @id @default(uuid())
  specialtyId String @map("specialty_id")
  serviceId   String @map("service_id")

  // Relations
  specialty   ProviderSpecialty @relation(fields: [specialtyId], references: [id], onDelete: Cascade)
  service     ServiceCatalog    @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now()) @map("created_at")

  @@unique([specialtyId, serviceId])
  @@index([specialtyId])
  @@index([serviceId])
  @@map("specialty_service_mappings")
}

// Provider capabilities (Work Team specialties)
model ProviderSpecialtyAssignment {
  id         String   @id @default(uuid())
  workTeamId String   @map("work_team_id")
  specialtyId String  @map("specialty_id")

  // Certification tracking
  isCertified Boolean  @default(false) @map("is_certified")
  certificationNumber String? @map("certification_number") @db.VarChar(100)
  certificationIssuedAt DateTime? @map("certification_issued_at")
  certificationExpiresAt DateTime? @map("certification_expires_at")

  // Experience tracking
  experienceLevel ExperienceLevel @map("experience_level")
  yearsOfExperience Int @default(0) @map("years_of_experience")

  // Performance metrics (updated after each job)
  totalJobsCompleted Int @default(0) @map("total_jobs_completed")
  totalJobsFailed    Int @default(0) @map("total_jobs_failed")
  avgDurationMinutes Int? @map("avg_duration_minutes")
  avgQualityScore    Decimal? @map("avg_quality_score") @db.Decimal(3, 2) // 0.00-5.00

  // Status
  isActive    Boolean  @default(true) @map("is_active")
  assignedAt  DateTime @default(now()) @map("assigned_at")
  revokedAt   DateTime? @map("revoked_at")
  revocationReason String? @map("revocation_reason") @db.Text

  // Relations
  workTeam    WorkTeam          @relation(fields: [workTeamId], references: [id], onDelete: Cascade)
  specialty   ProviderSpecialty @relation(fields: [specialtyId], references: [id], onDelete: Cascade)

  // Audit
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([workTeamId, specialtyId])
  @@index([workTeamId])
  @@index([specialtyId])
  @@index([isActive])
  @@index([certificationExpiresAt]) // Monitor expiring certifications
  @@map("provider_specialty_assignments")
}

// ----------------------------------------------------------------------------
// CONTRACT TEMPLATES
// ----------------------------------------------------------------------------

model ContractTemplate {
  id              String   @id @default(uuid())
  code            String   @unique @db.VarChar(50) // INSTALL_STD_V1, TV_QUOTE_V2
  name            String   @db.VarChar(255)
  description     String?  @db.Text

  // Multi-tenancy
  countryCode     String   @map("country_code") @db.VarChar(3)
  businessUnit    String?  @map("business_unit") @db.VarChar(50) // NULL = all BUs

  // External template reference (Adobe Sign / DocuSign agnostic)
  externalTemplateId String @map("external_template_id") @db.VarChar(100)
  provider        ContractProvider // ADOBE_SIGN, DOCUSIGN

  // Versioning
  version         Int      @default(1)
  isActive        Boolean  @default(true) @map("is_active")
  supersededBy    String?  @map("superseded_by") // ID of newer version

  // Relations
  services        ServiceCatalog[]

  // Audit
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  createdBy       String?  @map("created_by") @db.VarChar(100)

  @@index([countryCode, businessUnit])
  @@index([isActive])
  @@map("contract_templates")
}

enum ContractProvider {
  ADOBE_SIGN
  DOCUSIGN
}

// ----------------------------------------------------------------------------
// SYNC INFRASTRUCTURE (Event tracking & reconciliation)
// ----------------------------------------------------------------------------

model ServiceCatalogEventLog {
  id                  String   @id @default(uuid())
  eventId             String   @unique @map("event_id") @db.VarChar(100) // For idempotency

  // Event metadata
  eventType           String   @map("event_type") @db.VarChar(50) // service.created, service.updated
  externalSource      String   @map("external_source") @db.VarChar(20) // PYXIS, TEMPO, SAP
  externalServiceCode String   @map("external_service_code") @db.VarChar(100)

  // Processing status
  processingStatus    EventProcessingStatus @map("processing_status")
  payload             Json     // Full event payload
  errorMessage        String?  @map("error_message") @db.Text
  retryCount          Int      @default(0) @map("retry_count")

  // Timestamps
  receivedAt          DateTime @default(now()) @map("received_at")
  processedAt         DateTime? @map("processed_at")

  @@index([eventId])
  @@index([processingStatus, receivedAt])
  @@index([externalServiceCode])
  @@map("service_catalog_event_log")
}

enum EventProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  DEAD_LETTER
}

model ServiceCatalogReconciliation {
  id                String   @id @default(uuid())

  // Reconciliation run metadata
  countryCode       String   @map("country_code") @db.VarChar(3)
  runDate           DateTime @map("run_date")
  status            ReconciliationStatus

  // Metrics
  totalServicesInFile     Int @map("total_services_in_file")
  totalServicesInDB       Int @map("total_services_in_db")
  servicesCreated         Int @default(0) @map("services_created")
  servicesUpdated         Int @default(0) @map("services_updated")
  servicesWithDrift       Int @default(0) @map("services_with_drift")
  driftPercentage         Decimal? @map("drift_percentage") @db.Decimal(5, 2)

  // File info
  s3Bucket          String?  @map("s3_bucket") @db.VarChar(100)
  s3Key             String?  @map("s3_key") @db.VarChar(255)

  // Timestamps
  startedAt         DateTime @default(now()) @map("started_at")
  completedAt       DateTime? @map("completed_at")
  errorMessage      String?  @map("error_message") @db.Text

  @@index([countryCode, runDate])
  @@index([status])
  @@map("service_catalog_reconciliation")
}

enum ReconciliationStatus {
  RUNNING
  COMPLETED
  FAILED
  PARTIAL
}

// ============================================================================
// PROJECT & SERVICE ORDER MODULE (Phase 2)
// ============================================================================

model Project {
  id                  String   @id @default(uuid())
  externalProjectId   String?  @unique @map("external_project_id") // Sales system project ID

  // Multi-tenancy
  countryCode         String   @map("country_code") @db.VarChar(3)
  businessUnit        String   @map("business_unit") @db.VarChar(50)

  // Customer information
  customerName        String   @map("customer_name") @db.VarChar(255)
  customerEmail       String?  @map("customer_email")
  customerPhone       String?  @map("customer_phone")
  customerAddress     Json     @map("customer_address") // {street, city, postalCode, country}

  // Project metadata
  projectName         String   @map("project_name") @db.VarChar(255)
  projectDescription  String?  @map("project_description") @db.Text

  // Project ownership (Pilote du Chantier)
  pilotUserId         String?  @map("pilot_user_id") // Responsible operator
  pilotAssignmentMode PilotAssignmentMode @default(AUTO) @map("pilot_assignment_mode")
  pilotAssignedAt     DateTime? @map("pilot_assigned_at")

  // External references (v2.0)
  externalSalesOrderId String?  @map("external_sales_order_id")
  externalLeadId       String?  @map("external_lead_id")
  externalSystemSource String?  @map("external_system_source") @db.VarChar(50) // PYXIS, TEMPO, SAP

  // Status
  status              ProjectStatus @default(CREATED)

  // Relations
  pilotUser           User?         @relation("ProjectPilot", fields: [pilotUserId], references: [id], onDelete: SetNull)
  serviceOrders       ServiceOrder[]

  // Audit
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  createdBy           String?  @map("created_by") @db.VarChar(100)

  @@index([countryCode, businessUnit])
  @@index([pilotUserId])
  @@index([status])
  @@index([externalProjectId])
  @@map("projects")
}

enum PilotAssignmentMode {
  AUTO    // Automatic workload balancing
  MANUAL  // Manual assignment by manager
}

enum ProjectStatus {
  CREATED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model ServiceOrder {
  id                      String   @id @default(uuid())
  externalServiceOrderId  String?  @unique @map("external_service_order_id")

  // Relations
  projectId               String?  @map("project_id")
  serviceId               String   @map("service_id")
  assignedProviderId      String?  @map("assigned_provider_id")
  assignedWorkTeamId      String?  @map("assigned_work_team_id")

  // Multi-tenancy
  countryCode             String   @map("country_code") @db.VarChar(3)
  businessUnit            String   @map("business_unit") @db.VarChar(50)

  // Customer information (can override project)
  customerInfo            Json     @map("customer_info") // {name, email, phone, address}

  // Service details
  serviceType             ServiceType @map("service_type")
  priority                ServicePriority
  estimatedDurationMinutes Int     @map("estimated_duration_minutes")

  // Location
  serviceAddress          Json     @map("service_address") // {street, city, postalCode, lat, lng}

  // Scheduling window
  requestedStartDate      DateTime @map("requested_start_date")
  requestedEndDate        DateTime @map("requested_end_date")
  requestedTimeSlot       String?  @map("requested_time_slot") // AM, PM, or specific time

  // Scheduled slot (after booking)
  scheduledDate           DateTime? @map("scheduled_date")
  scheduledStartTime      DateTime? @map("scheduled_start_time")
  scheduledEndTime        DateTime? @map("scheduled_end_time")

  // External sales references (v2.0)
  externalSalesOrderId    String?  @map("external_sales_order_id")
  externalProjectId       String?  @map("external_project_id")
  externalLeadId          String?  @map("external_lead_id")
  externalSystemSource    String?  @map("external_system_source") @db.VarChar(50)

  // Sales potential (TV/Quotation only - v2.0)
  salesPotential          SalesPotential? @map("sales_potential")
  salesPotentialScore     Decimal?  @map("sales_potential_score") @db.Decimal(5, 2) // 0-100
  salesPotentialUpdatedAt DateTime? @map("sales_potential_updated_at")
  salesPreEstimationId    String?   @map("sales_pre_estimation_id")
  salesPreEstimationValue Decimal?  @map("sales_pre_estimation_value") @db.Decimal(10, 2)
  salesmanNotes           String?   @map("salesman_notes") @db.Text

  // Risk assessment (v2.0)
  riskLevel               RiskLevel @default(LOW) @map("risk_level")
  riskScore               Decimal?  @map("risk_score") @db.Decimal(5, 2) // 0-100
  riskAssessedAt          DateTime? @map("risk_assessed_at")
  riskAcknowledgedBy      String?   @map("risk_acknowledged_by")
  riskAcknowledgedAt      DateTime? @map("risk_acknowledged_at")

  // State machine
  state                   ServiceOrderState @default(CREATED)
  stateChangedAt          DateTime @default(now()) @map("state_changed_at")

  // Relations
  project                 Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)
  service                 ServiceCatalog @relation(fields: [serviceId], references: [id], onDelete: Restrict)
  assignedProvider        Provider? @relation(fields: [assignedProviderId], references: [id], onDelete: SetNull)
  assignedWorkTeam        WorkTeam? @relation(fields: [assignedWorkTeamId], references: [id], onDelete: SetNull)
  dependencies            ServiceOrderDependency[] @relation("DependentOrder")
  dependents              ServiceOrderDependency[] @relation("BlockedOrder")
  buffers                 ServiceOrderBuffer[]
  assignments             Assignment[]
  bookings                Booking[]
  riskFactors             ServiceOrderRiskFactor[]

  // Audit
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  createdBy               String?  @map("created_by") @db.VarChar(100)

  @@index([projectId])
  @@index([serviceId])
  @@index([assignedProviderId])
  @@index([assignedWorkTeamId])
  @@index([countryCode, businessUnit])
  @@index([state])
  @@index([priority])
  @@index([scheduledDate])
  @@index([riskLevel])
  @@map("service_orders")
}

enum ServicePriority {
  P1  // Priority: 24-72h response
  P2  // Standard: 3-7 days response
}

enum ServiceOrderState {
  CREATED
  SCHEDULED
  ASSIGNED
  ACCEPTED
  IN_PROGRESS
  COMPLETED
  VALIDATED
  CLOSED
  CANCELLED
}

enum SalesPotential {
  LOW
  MEDIUM
  HIGH
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model ServiceOrderDependency {
  id                 String   @id @default(uuid())

  // The service order that depends on another
  dependentOrderId   String   @map("dependent_order_id")

  // The service order that must be completed first
  blocksOrderId      String   @map("blocks_order_id")

  // Dependency type
  dependencyType     DependencyType @map("dependency_type")

  // Static buffer between dependent services (in days)
  staticBufferDays   Int      @default(0) @map("static_buffer_days")

  // Relations
  dependentOrder     ServiceOrder @relation("DependentOrder", fields: [dependentOrderId], references: [id], onDelete: Cascade)
  blockedOrder       ServiceOrder @relation("BlockedOrder", fields: [blocksOrderId], references: [id], onDelete: Cascade)

  createdAt          DateTime @default(now()) @map("created_at")

  @@unique([dependentOrderId, blocksOrderId])
  @@index([dependentOrderId])
  @@index([blocksOrderId])
  @@map("service_order_dependencies")
}

enum DependencyType {
  REQUIRES_COMPLETION  // Must finish first
  REQUIRES_VALIDATION  // Must be validated first
}

model ServiceOrderBuffer {
  id                       String       @id @default(uuid())
  serviceOrderId           String       @map("service_order_id")

  // Travel buffer (PRD-compliant: fixed minutes before/after job)
  // Applied when work team has multiple jobs in one day
  travelBufferMinutesStart Int          @default(0) @map("travel_buffer_minutes_start")
  travelBufferMinutesEnd   Int          @default(0) @map("travel_buffer_minutes_end")

  // Reason for transparency
  reason                   String       @db.Text
  appliedAt                DateTime     @default(now()) @map("applied_at")

  // Configuration reference
  configRef                String?      @map("config_ref") // Reference to CalendarConfig

  // Relations
  serviceOrder             ServiceOrder @relation(fields: [serviceOrderId], references: [id], onDelete: Cascade)

  @@unique([serviceOrderId])
  @@index([serviceOrderId])
  @@map("service_order_buffers")
}

model ServiceOrderRiskFactor {
  id             String   @id @default(uuid())
  serviceOrderId String   @map("service_order_id")

  // Risk factor details
  factorType     RiskFactorType @map("factor_type")
  factorScore    Decimal  @map("factor_score") @db.Decimal(5, 2) // Contribution to risk score
  description    String   @db.Text

  // Detection
  detectedAt     DateTime @default(now()) @map("detected_at")
  detectedBy     String   @map("detected_by") @db.VarChar(50) // SYSTEM, USER_EMAIL

  // Relations
  serviceOrder   ServiceOrder @relation(fields: [serviceOrderId], references: [id], onDelete: Cascade)

  @@index([serviceOrderId])
  @@map("service_order_risk_factors")
}

enum RiskFactorType {
  CLAIM_HISTORY
  RESCHEDULE_FREQUENCY
  PAYMENT_ISSUES
  PROVIDER_QUALITY
  COMPLEX_SERVICE
  CUSTOMER_HISTORY
}

// ============================================================================
// ASSIGNMENT & DISPATCH MODULE (Phase 2)
// ============================================================================

model Assignment {
  id                      String   @id @default(uuid())
  serviceOrderId          String   @map("service_order_id")
  providerId              String   @map("provider_id")
  workTeamId              String?  @map("work_team_id")

  // Assignment metadata
  assignmentMode          AssignmentMode @map("assignment_mode")
  assignmentMethod        String   @map("assignment_method") @db.VarChar(50) // DIRECT, OFFER, BROADCAST, AUTO

  // Assignment funnel
  funnelExecutionId       String?  @map("funnel_execution_id") // Link to funnel audit
  providerRank            Int?     @map("provider_rank") // Rank in candidate list
  providerScore           Decimal? @map("provider_score") @db.Decimal(5, 2)
  scoreBreakdown          Json?    @map("score_breakdown") // Detailed scoring

  // State
  state                   AssignmentState @default(PENDING)
  stateChangedAt          DateTime @default(now()) @map("state_changed_at")

  // Provider response
  acceptedAt              DateTime? @map("accepted_at")
  rejectedAt              DateTime? @map("rejected_at")
  rejectionReason         String?   @map("rejection_reason") @db.Text

  // Date negotiation (up to 3 rounds)
  negotiationRound        Int      @default(0) @map("negotiation_round")
  proposedDate            DateTime? @map("proposed_date")
  counterproposalDate     DateTime? @map("counterproposal_date")

  // Relations
  serviceOrder            ServiceOrder @relation(fields: [serviceOrderId], references: [id], onDelete: Cascade)
  provider                Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  workTeam                WorkTeam? @relation(fields: [workTeamId], references: [id], onDelete: SetNull)

  // Audit
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")
  createdBy               String?  @map("created_by") @db.VarChar(100)

  @@index([serviceOrderId])
  @@index([providerId])
  @@index([workTeamId])
  @@index([state])
  @@index([funnelExecutionId])
  @@map("assignments")
}

enum AssignmentMode {
  DIRECT        // Operator selects specific provider
  OFFER         // Send offer, wait for acceptance
  BROADCAST     // Send to multiple providers
  AUTO_ACCEPT   // Auto-accept (ES/IT only)
}

enum AssignmentState {
  PENDING
  OFFERED
  ACCEPTED
  DECLINED
  CANCELLED
  EXPIRED
}

model AssignmentFunnelExecution {
  id                       String   @id @default(uuid())
  serviceOrderId           String   @map("service_order_id")

  // Funnel input
  requestedDate            DateTime @map("requested_date")
  requestedSlot            String?  @map("requested_slot")

  // Funnel results
  totalProvidersEvaluated  Int      @map("total_providers_evaluated")
  eligibleProviders        Int      @map("eligible_providers")
  funnelSteps              Json     @map("funnel_steps") // Array of funnel step audits

  // Execution metadata
  executionTimeMs          Int      @map("execution_time_ms")
  executedAt               DateTime @default(now()) @map("executed_at")
  executedBy               String   @map("executed_by") @db.VarChar(100)

  @@index([serviceOrderId])
  @@index([executedAt])
  @@map("assignment_funnel_executions")
}

// ============================================================================
// CALENDAR & BOOKING MODULE (Phase 2)
// ============================================================================

model Booking {
  id               String   @id @default(uuid())
  serviceOrderId   String   @map("service_order_id")
  providerId       String   @map("provider_id")
  workTeamId       String   @map("work_team_id")

  // Booking slot
  bookingDate      DateTime @map("booking_date") @db.Date
  startSlot        Int      @map("start_slot") // 0-95 (15-min slots)
  endSlot          Int      @map("end_slot")   // 0-95
  durationMinutes  Int      @map("duration_minutes")

  // Booking type
  bookingType      BookingType @map("booking_type")

  // Pre-booking (temporary hold)
  expiresAt        DateTime? @map("expires_at")
  holdReference    String?   @unique @map("hold_reference") // For idempotency

  // Status
  status           BookingStatus @default(PRE_BOOKED)
  confirmedAt      DateTime? @map("confirmed_at")
  cancelledAt      DateTime? @map("cancelled_at")
  cancellationReason String? @map("cancellation_reason") @db.Text

  // Relations
  serviceOrder     ServiceOrder @relation(fields: [serviceOrderId], references: [id], onDelete: Cascade)
  provider         Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  workTeam         WorkTeam @relation(fields: [workTeamId], references: [id], onDelete: Restrict)

  // Audit
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  createdBy        String?  @map("created_by") @db.VarChar(100)

  @@unique([workTeamId, bookingDate, startSlot, endSlot])
  @@index([serviceOrderId])
  @@index([providerId])
  @@index([workTeamId, bookingDate])
  @@index([status])
  @@index([expiresAt])
  @@map("bookings")
}

enum BookingType {
  SERVICE_ORDER   // Regular service order booking
  EXTERNAL_BLOCK  // Manual block (vacation, maintenance)
  STORE_CLOSURE   // Store/provider closure
}

enum BookingStatus {
  PRE_BOOKED      // Temporary hold (48h TTL)
  CONFIRMED       // Confirmed booking
  CANCELLED       // Cancelled
  EXPIRED         // Pre-booking expired
}

// ============================================================================
// CALENDAR CONFIGURATION MODULE (Phase 2 - PRD Compliant)
// ============================================================================

model CalendarConfig {
  id                         String   @id @default(uuid())

  // Multi-tenancy
  countryCode                String   @map("country_code") @db.VarChar(3)
  businessUnit               String   @map("business_unit") @db.VarChar(50)

  // Working days (0=Sunday, 1=Monday, ..., 6=Saturday)
  workingDays                Json     @map("working_days") // [1,2,3,4,5] for Mon-Fri
  timezone                   String   @db.VarChar(50) // Europe/Madrid, Europe/Paris

  // Shift definitions
  morningShiftStart          String   @map("morning_shift_start") @db.VarChar(5) // "08:00"
  morningShiftEnd            String   @map("morning_shift_end") @db.VarChar(5)   // "14:00"
  afternoonShiftStart        String   @map("afternoon_shift_start") @db.VarChar(5) // "14:00"
  afternoonShiftEnd          String   @map("afternoon_shift_end") @db.VarChar(5) // "20:00"
  eveningShiftStart          String?  @map("evening_shift_start") @db.VarChar(5)  // "20:00" (optional)
  eveningShiftEnd            String?  @map("evening_shift_end") @db.VarChar(5)    // "22:00"

  // PRD-compliant buffer configuration (BR-5)
  // Global buffer: Block bookings within N non-working days from today
  globalBufferNonWorkingDays Int      @default(0) @map("global_buffer_non_working_days")
  // Static buffer: Block bookings within N non-working days from deliveryDate
  staticBufferNonWorkingDays Int      @default(0) @map("static_buffer_non_working_days")
  // Travel buffer: Fixed minutes added before/after each job
  travelBufferMinutes        Int      @default(0) @map("travel_buffer_minutes")

  // Cross-day jobs allowed
  crossDayAllowed            Boolean  @default(false) @map("cross_day_allowed")

  // Holiday region code for Nager.Date API (supports regional holidays)
  holidayRegion              String?  @map("holiday_region") @db.VarChar(10) // e.g., "MD" for Madrid

  // Audit
  createdAt                  DateTime @default(now()) @map("created_at")
  updatedAt                  DateTime @updatedAt @map("updated_at")
  createdBy                  String?  @map("created_by") @db.VarChar(100)

  @@unique([countryCode, businessUnit])
  @@index([countryCode, businessUnit])
  @@map("calendar_configs")
}

// ============================================================================
// HOLIDAY CALENDAR (for buffer calculations)
// ============================================================================

model Holiday {
  id          String   @id @default(uuid())

  // Multi-tenancy
  countryCode String   @map("country_code") @db.VarChar(3)

  // Holiday details
  date        DateTime @db.Date
  name        String   @db.VarChar(255)
  isNational  Boolean  @default(true) @map("is_national")
  regions     Json?    // Array of region codes if regional

  // Relations
  createdAt   DateTime @default(now()) @map("created_at")

  @@unique([countryCode, date])
  @@index([countryCode, date])
  @@map("holidays")
}