<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" 
                  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" 
                  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" 
                  xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xmlns:zeebe="http://camunda.org/schema/zeebe/1.0" 
                  xmlns:modeler="http://camunda.org/schema/modeler/1.0" 
                  id="Definitions_ServiceOrderLifecycle" 
                  targetNamespace="http://bpmn.io/schema/bpmn" 
                  exporter="Camunda Modeler" 
                  exporterVersion="5.19.0" 
                  modeler:executionPlatform="Camunda Cloud" 
                  modeler:executionPlatformVersion="8.5.0">
  
  <bpmn:process id="ServiceOrderLifecycle" name="Service Order Lifecycle" isExecutable="true">
    
    <!-- START EVENT -->
    <bpmn:startEvent id="StartEvent_OrderCreated" name="Order Created">
      <bpmn:outgoing>Flow_ToValidation</bpmn:outgoing>
    </bpmn:startEvent>
    
    <!-- VALIDATION -->
    <bpmn:serviceTask id="Task_ValidateOrder" name="Validate Order">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="validate-order" />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_ToValidation</bpmn:incoming>
      <bpmn:outgoing>Flow_ToAssignment</bpmn:outgoing>
    </bpmn:serviceTask>
    
    <!-- PROVIDER ASSIGNMENT SUB-PROCESS -->
    <bpmn:callActivity id="SubProcess_Assignment" name="Provider Assignment">
      <bpmn:extensionElements>
        <zeebe:calledElement processId="ProviderAssignment" propagateAllChildVariables="true" />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_ToAssignment</bpmn:incoming>
      <bpmn:outgoing>Flow_ToScheduling</bpmn:outgoing>
    </bpmn:callActivity>
    
    <!-- SCHEDULING -->
    <bpmn:serviceTask id="Task_CheckAvailability" name="Check Availability">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="check-availability" />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_ToScheduling</bpmn:incoming>
      <bpmn:outgoing>Flow_ToReserve</bpmn:outgoing>
    </bpmn:serviceTask>
    
    <bpmn:serviceTask id="Task_ReserveSlot" name="Reserve Slot">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="reserve-slot" />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_ToReserve</bpmn:incoming>
      <bpmn:outgoing>Flow_ToWaitGoCheck</bpmn:outgoing>
    </bpmn:serviceTask>
    
    <!-- WAIT FOR GO CHECK TIMER -->
    <bpmn:intermediateCatchEvent id="Timer_WaitForGoCheck" name="Wait until 48h before">
      <bpmn:incoming>Flow_ToWaitGoCheck</bpmn:incoming>
      <bpmn:outgoing>Flow_ToGoCheck</bpmn:outgoing>
      <bpmn:timerEventDefinition id="TimerDef_GoCheck">
        <bpmn:timeDuration xsi:type="bpmn:tFormalExpression">= goCheckWaitDuration</bpmn:timeDuration>
      </bpmn:timerEventDefinition>
    </bpmn:intermediateCatchEvent>
    
    <!-- GO CHECK -->
    <bpmn:serviceTask id="Task_GoCheck" name="GO Check">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="go-check" />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_ToGoCheck</bpmn:incoming>
      <bpmn:outgoing>Flow_ToGoDecision</bpmn:outgoing>
    </bpmn:serviceTask>
    
    <!-- GO DECISION GATEWAY -->
    <bpmn:exclusiveGateway id="Gateway_GoStatus" name="GO Status?">
      <bpmn:incoming>Flow_ToGoDecision</bpmn:incoming>
      <bpmn:outgoing>Flow_GoOk</bpmn:outgoing>
      <bpmn:outgoing>Flow_GoNok</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    
    <!-- EXECUTION -->
    <bpmn:serviceTask id="Task_NotifyExecution" name="Notify Ready for Execution">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="send-notification" />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_GoOk</bpmn:incoming>
      <bpmn:outgoing>Flow_ToEnd</bpmn:outgoing>
    </bpmn:serviceTask>
    
    <!-- END EVENTS -->
    <bpmn:endEvent id="EndEvent_Completed" name="Order Completed">
      <bpmn:incoming>Flow_ToEnd</bpmn:incoming>
    </bpmn:endEvent>
    
    <bpmn:endEvent id="EndEvent_Blocked" name="Execution Blocked">
      <bpmn:incoming>Flow_GoNok</bpmn:incoming>
    </bpmn:endEvent>
    
    <!-- SEQUENCE FLOWS -->
    <bpmn:sequenceFlow id="Flow_ToValidation" sourceRef="StartEvent_OrderCreated" targetRef="Task_ValidateOrder" />
    <bpmn:sequenceFlow id="Flow_ToAssignment" sourceRef="Task_ValidateOrder" targetRef="SubProcess_Assignment" />
    <bpmn:sequenceFlow id="Flow_ToScheduling" sourceRef="SubProcess_Assignment" targetRef="Task_CheckAvailability" />
    <bpmn:sequenceFlow id="Flow_ToReserve" sourceRef="Task_CheckAvailability" targetRef="Task_ReserveSlot" />
    <bpmn:sequenceFlow id="Flow_ToWaitGoCheck" sourceRef="Task_ReserveSlot" targetRef="Timer_WaitForGoCheck" />
    <bpmn:sequenceFlow id="Flow_ToGoCheck" sourceRef="Timer_WaitForGoCheck" targetRef="Task_GoCheck" />
    <bpmn:sequenceFlow id="Flow_ToGoDecision" sourceRef="Task_GoCheck" targetRef="Gateway_GoStatus" />
    <bpmn:sequenceFlow id="Flow_GoOk" name="GO_OK" sourceRef="Gateway_GoStatus" targetRef="Task_NotifyExecution">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">= goStatus = "GO_OK"</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_GoNok" name="GO_NOK" sourceRef="Gateway_GoStatus" targetRef="EndEvent_Blocked">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">= goStatus != "GO_OK"</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_ToEnd" sourceRef="Task_NotifyExecution" targetRef="EndEvent_Completed" />
    
  </bpmn:process>
  
  <!-- DIAGRAM SECTION - Required for Camunda Modeler -->
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="ServiceOrderLifecycle">
      <bpmndi:BPMNShape id="StartEvent_OrderCreated_di" bpmnElement="StartEvent_OrderCreated">
        <dc:Bounds x="152" y="102" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="138" y="145" width="65" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Task_ValidateOrder_di" bpmnElement="Task_ValidateOrder">
        <dc:Bounds x="240" y="80" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SubProcess_Assignment_di" bpmnElement="SubProcess_Assignment">
        <dc:Bounds x="390" y="80" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Task_CheckAvailability_di" bpmnElement="Task_CheckAvailability">
        <dc:Bounds x="540" y="80" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Task_ReserveSlot_di" bpmnElement="Task_ReserveSlot">
        <dc:Bounds x="690" y="80" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Timer_WaitForGoCheck_di" bpmnElement="Timer_WaitForGoCheck">
        <dc:Bounds x="842" y="102" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="820" y="145" width="80" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Task_GoCheck_di" bpmnElement="Task_GoCheck">
        <dc:Bounds x="930" y="80" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Gateway_GoStatus_di" bpmnElement="Gateway_GoStatus" isMarkerVisible="true">
        <dc:Bounds x="1085" y="95" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1082" y="65" width="56" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Task_NotifyExecution_di" bpmnElement="Task_NotifyExecution">
        <dc:Bounds x="1190" y="80" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="EndEvent_Completed_di" bpmnElement="EndEvent_Completed">
        <dc:Bounds x="1352" y="102" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1330" y="145" width="81" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="EndEvent_Blocked_di" bpmnElement="EndEvent_Blocked">
        <dc:Bounds x="1192" y="212" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1168" y="255" width="84" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Flow_ToValidation_di" bpmnElement="Flow_ToValidation">
        <di:waypoint x="188" y="120" />
        <di:waypoint x="240" y="120" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_ToAssignment_di" bpmnElement="Flow_ToAssignment">
        <di:waypoint x="340" y="120" />
        <di:waypoint x="390" y="120" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_ToScheduling_di" bpmnElement="Flow_ToScheduling">
        <di:waypoint x="490" y="120" />
        <di:waypoint x="540" y="120" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_ToReserve_di" bpmnElement="Flow_ToReserve">
        <di:waypoint x="640" y="120" />
        <di:waypoint x="690" y="120" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_ToWaitGoCheck_di" bpmnElement="Flow_ToWaitGoCheck">
        <di:waypoint x="790" y="120" />
        <di:waypoint x="842" y="120" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_ToGoCheck_di" bpmnElement="Flow_ToGoCheck">
        <di:waypoint x="878" y="120" />
        <di:waypoint x="930" y="120" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_ToGoDecision_di" bpmnElement="Flow_ToGoDecision">
        <di:waypoint x="1030" y="120" />
        <di:waypoint x="1085" y="120" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_GoOk_di" bpmnElement="Flow_GoOk">
        <di:waypoint x="1135" y="120" />
        <di:waypoint x="1190" y="120" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1145" y="102" width="35" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_GoNok_di" bpmnElement="Flow_GoNok">
        <di:waypoint x="1110" y="145" />
        <di:waypoint x="1110" y="230" />
        <di:waypoint x="1192" y="230" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1121" y="183" width="42" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_ToEnd_di" bpmnElement="Flow_ToEnd">
        <di:waypoint x="1290" y="120" />
        <di:waypoint x="1352" y="120" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>
