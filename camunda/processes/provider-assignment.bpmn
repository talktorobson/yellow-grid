<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" 
                  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" 
                  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" 
                  xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xmlns:zeebe="http://camunda.org/schema/zeebe/1.0" 
                  xmlns:modeler="http://camunda.org/schema/modeler/1.0" 
                  id="Definitions_ProviderAssignment" 
                  targetNamespace="http://bpmn.io/schema/bpmn" 
                  exporter="Camunda Modeler" 
                  exporterVersion="5.19.0" 
                  modeler:executionPlatform="Camunda Cloud" 
                  modeler:executionPlatformVersion="8.5.0">
  
  <bpmn:process id="ProviderAssignment" name="Provider Assignment" isExecutable="true">
    
    <!-- START EVENT -->
    <bpmn:startEvent id="StartEvent_Assignment" name="Start Assignment">
      <bpmn:outgoing>Flow_ToFindProviders</bpmn:outgoing>
    </bpmn:startEvent>
    
    <!-- FIND AND RANK PROVIDERS -->
    <bpmn:serviceTask id="Task_FindProviders" name="Find Eligible Providers">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="find-providers" />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_ToFindProviders</bpmn:incoming>
      <bpmn:outgoing>Flow_ToRankProviders</bpmn:outgoing>
    </bpmn:serviceTask>
    
    <bpmn:serviceTask id="Task_RankProviders" name="Rank Providers">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="rank-providers" />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_ToRankProviders</bpmn:incoming>
      <bpmn:outgoing>Flow_ToProviderCheck</bpmn:outgoing>
    </bpmn:serviceTask>
    
    <!-- CHECK IF PROVIDERS AVAILABLE -->
    <bpmn:exclusiveGateway id="Gateway_ProvidersAvailable" name="Providers Available?">
      <bpmn:incoming>Flow_ToProviderCheck</bpmn:incoming>
      <bpmn:outgoing>Flow_HasProviders</bpmn:outgoing>
      <bpmn:outgoing>Flow_NoProviders</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    
    <!-- AUTO-ASSIGN IF POSSIBLE -->
    <bpmn:serviceTask id="Task_AutoAssign" name="Auto-Assign Provider">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="auto-assign-provider" />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_HasProviders</bpmn:incoming>
      <bpmn:outgoing>Flow_ToAutoAssignCheck</bpmn:outgoing>
    </bpmn:serviceTask>
    
    <!-- CHECK AUTO-ASSIGN RESULT -->
    <bpmn:exclusiveGateway id="Gateway_AutoAssignResult" name="Auto-Assigned?">
      <bpmn:incoming>Flow_ToAutoAssignCheck</bpmn:incoming>
      <bpmn:outgoing>Flow_AutoAssigned</bpmn:outgoing>
      <bpmn:outgoing>Flow_SendOffer</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    
    <!-- SEND OFFER TO PROVIDER -->
    <bpmn:serviceTask id="Task_SendOffer" name="Send Offer to Provider">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="send-offer" />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_SendOffer</bpmn:incoming>
      <bpmn:outgoing>Flow_ToOfferWait</bpmn:outgoing>
    </bpmn:serviceTask>
    
    <!-- WAIT FOR OFFER RESPONSE WITH TIMEOUT -->
    <bpmn:eventBasedGateway id="Gateway_OfferResponse" name="Await Response">
      <bpmn:incoming>Flow_ToOfferWait</bpmn:incoming>
      <bpmn:outgoing>Flow_ToAcceptMessage</bpmn:outgoing>
      <bpmn:outgoing>Flow_ToRejectMessage</bpmn:outgoing>
      <bpmn:outgoing>Flow_ToTimeout</bpmn:outgoing>
    </bpmn:eventBasedGateway>
    
    <!-- OFFER ACCEPTED MESSAGE -->
    <bpmn:intermediateCatchEvent id="Event_OfferAccepted" name="Offer Accepted">
      <bpmn:incoming>Flow_ToAcceptMessage</bpmn:incoming>
      <bpmn:outgoing>Flow_Accepted</bpmn:outgoing>
      <bpmn:messageEventDefinition id="MsgDef_Accepted" messageRef="Message_OfferAccepted" />
    </bpmn:intermediateCatchEvent>
    
    <!-- OFFER REJECTED MESSAGE -->
    <bpmn:intermediateCatchEvent id="Event_OfferRejected" name="Offer Rejected">
      <bpmn:incoming>Flow_ToRejectMessage</bpmn:incoming>
      <bpmn:outgoing>Flow_Rejected</bpmn:outgoing>
      <bpmn:messageEventDefinition id="MsgDef_Rejected" messageRef="Message_OfferRejected" />
    </bpmn:intermediateCatchEvent>
    
    <!-- OFFER TIMEOUT -->
    <bpmn:intermediateCatchEvent id="Event_OfferTimeout" name="Offer Timeout (4h)">
      <bpmn:incoming>Flow_ToTimeout</bpmn:incoming>
      <bpmn:outgoing>Flow_Timeout</bpmn:outgoing>
      <bpmn:timerEventDefinition id="TimerDef_Timeout">
        <bpmn:timeDuration xsi:type="bpmn:tFormalExpression">PT4H</bpmn:timeDuration>
      </bpmn:timerEventDefinition>
    </bpmn:intermediateCatchEvent>
    
    <!-- END EVENTS -->
    <bpmn:endEvent id="EndEvent_Assigned" name="Provider Assigned">
      <bpmn:incoming>Flow_AutoAssigned</bpmn:incoming>
      <bpmn:incoming>Flow_Accepted</bpmn:incoming>
    </bpmn:endEvent>
    
    <bpmn:endEvent id="EndEvent_NoProvider" name="No Provider Available">
      <bpmn:incoming>Flow_NoProviders</bpmn:incoming>
    </bpmn:endEvent>
    
    <bpmn:endEvent id="EndEvent_OfferDeclined" name="Offer Declined">
      <bpmn:incoming>Flow_Rejected</bpmn:incoming>
      <bpmn:incoming>Flow_Timeout</bpmn:incoming>
    </bpmn:endEvent>
    
    <!-- SEQUENCE FLOWS -->
    <bpmn:sequenceFlow id="Flow_ToFindProviders" sourceRef="StartEvent_Assignment" targetRef="Task_FindProviders" />
    <bpmn:sequenceFlow id="Flow_ToRankProviders" sourceRef="Task_FindProviders" targetRef="Task_RankProviders" />
    <bpmn:sequenceFlow id="Flow_ToProviderCheck" sourceRef="Task_RankProviders" targetRef="Gateway_ProvidersAvailable" />
    <bpmn:sequenceFlow id="Flow_HasProviders" name="Yes" sourceRef="Gateway_ProvidersAvailable" targetRef="Task_AutoAssign">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">= count(rankedProviders) > 0</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_NoProviders" name="No" sourceRef="Gateway_ProvidersAvailable" targetRef="EndEvent_NoProvider">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">= count(rankedProviders) = 0</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_ToAutoAssignCheck" sourceRef="Task_AutoAssign" targetRef="Gateway_AutoAssignResult" />
    <bpmn:sequenceFlow id="Flow_AutoAssigned" name="Yes" sourceRef="Gateway_AutoAssignResult" targetRef="EndEvent_Assigned">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">= autoAssigned = true</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_SendOffer" name="No" sourceRef="Gateway_AutoAssignResult" targetRef="Task_SendOffer">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">= autoAssigned = false</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_ToOfferWait" sourceRef="Task_SendOffer" targetRef="Gateway_OfferResponse" />
    <bpmn:sequenceFlow id="Flow_ToAcceptMessage" sourceRef="Gateway_OfferResponse" targetRef="Event_OfferAccepted" />
    <bpmn:sequenceFlow id="Flow_ToRejectMessage" sourceRef="Gateway_OfferResponse" targetRef="Event_OfferRejected" />
    <bpmn:sequenceFlow id="Flow_ToTimeout" sourceRef="Gateway_OfferResponse" targetRef="Event_OfferTimeout" />
    <bpmn:sequenceFlow id="Flow_Accepted" sourceRef="Event_OfferAccepted" targetRef="EndEvent_Assigned" />
    <bpmn:sequenceFlow id="Flow_Rejected" sourceRef="Event_OfferRejected" targetRef="EndEvent_OfferDeclined" />
    <bpmn:sequenceFlow id="Flow_Timeout" sourceRef="Event_OfferTimeout" targetRef="EndEvent_OfferDeclined" />
    
  </bpmn:process>
  
  <!-- MESSAGE DEFINITIONS -->
  <bpmn:message id="Message_OfferAccepted" name="OfferAccepted">
    <bpmn:extensionElements>
      <zeebe:subscription correlationKey="= offerId" />
    </bpmn:extensionElements>
  </bpmn:message>
  
  <bpmn:message id="Message_OfferRejected" name="OfferRejected">
    <bpmn:extensionElements>
      <zeebe:subscription correlationKey="= offerId" />
    </bpmn:extensionElements>
  </bpmn:message>
  
  <!-- DIAGRAM SECTION - Required for Camunda Modeler -->
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="ProviderAssignment">
      <bpmndi:BPMNShape id="StartEvent_Assignment_di" bpmnElement="StartEvent_Assignment">
        <dc:Bounds x="152" y="202" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="130" y="245" width="81" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Task_FindProviders_di" bpmnElement="Task_FindProviders">
        <dc:Bounds x="240" y="180" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Task_RankProviders_di" bpmnElement="Task_RankProviders">
        <dc:Bounds x="390" y="180" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Gateway_ProvidersAvailable_di" bpmnElement="Gateway_ProvidersAvailable" isMarkerVisible="true">
        <dc:Bounds x="545" y="195" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="545" y="165" width="50" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Task_AutoAssign_di" bpmnElement="Task_AutoAssign">
        <dc:Bounds x="650" y="180" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Gateway_AutoAssignResult_di" bpmnElement="Gateway_AutoAssignResult" isMarkerVisible="true">
        <dc:Bounds x="805" y="195" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="795" y="165" width="71" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Task_SendOffer_di" bpmnElement="Task_SendOffer">
        <dc:Bounds x="910" y="180" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Gateway_OfferResponse_di" bpmnElement="Gateway_OfferResponse">
        <dc:Bounds x="1065" y="195" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1050" y="165" width="80" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_OfferAccepted_di" bpmnElement="Event_OfferAccepted">
        <dc:Bounds x="1172" y="102" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1153" y="78" width="73" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_OfferRejected_di" bpmnElement="Event_OfferRejected">
        <dc:Bounds x="1172" y="202" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1155" y="245" width="71" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_OfferTimeout_di" bpmnElement="Event_OfferTimeout">
        <dc:Bounds x="1172" y="302" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1149" y="345" width="82" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="EndEvent_Assigned_di" bpmnElement="EndEvent_Assigned">
        <dc:Bounds x="1312" y="102" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1287" y="145" width="87" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="EndEvent_NoProvider_di" bpmnElement="EndEvent_NoProvider">
        <dc:Bounds x="652" y="322" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="627" y="365" width="87" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="EndEvent_OfferDeclined_di" bpmnElement="EndEvent_OfferDeclined">
        <dc:Bounds x="1312" y="252" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1295" y="295" width="71" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Flow_ToFindProviders_di" bpmnElement="Flow_ToFindProviders">
        <di:waypoint x="188" y="220" />
        <di:waypoint x="240" y="220" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_ToRankProviders_di" bpmnElement="Flow_ToRankProviders">
        <di:waypoint x="340" y="220" />
        <di:waypoint x="390" y="220" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_ToProviderCheck_di" bpmnElement="Flow_ToProviderCheck">
        <di:waypoint x="490" y="220" />
        <di:waypoint x="545" y="220" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_HasProviders_di" bpmnElement="Flow_HasProviders">
        <di:waypoint x="595" y="220" />
        <di:waypoint x="650" y="220" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="614" y="202" width="18" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_NoProviders_di" bpmnElement="Flow_NoProviders">
        <di:waypoint x="570" y="245" />
        <di:waypoint x="570" y="340" />
        <di:waypoint x="652" y="340" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="578" y="290" width="15" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_ToAutoAssignCheck_di" bpmnElement="Flow_ToAutoAssignCheck">
        <di:waypoint x="750" y="220" />
        <di:waypoint x="805" y="220" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_AutoAssigned_di" bpmnElement="Flow_AutoAssigned">
        <di:waypoint x="830" y="195" />
        <di:waypoint x="830" y="120" />
        <di:waypoint x="1312" y="120" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="836" y="155" width="18" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_SendOffer_di" bpmnElement="Flow_SendOffer">
        <di:waypoint x="855" y="220" />
        <di:waypoint x="910" y="220" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="875" y="202" width="15" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_ToOfferWait_di" bpmnElement="Flow_ToOfferWait">
        <di:waypoint x="1010" y="220" />
        <di:waypoint x="1065" y="220" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_ToAcceptMessage_di" bpmnElement="Flow_ToAcceptMessage">
        <di:waypoint x="1090" y="195" />
        <di:waypoint x="1090" y="120" />
        <di:waypoint x="1172" y="120" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_ToRejectMessage_di" bpmnElement="Flow_ToRejectMessage">
        <di:waypoint x="1115" y="220" />
        <di:waypoint x="1172" y="220" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_ToTimeout_di" bpmnElement="Flow_ToTimeout">
        <di:waypoint x="1090" y="245" />
        <di:waypoint x="1090" y="320" />
        <di:waypoint x="1172" y="320" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_Accepted_di" bpmnElement="Flow_Accepted">
        <di:waypoint x="1208" y="120" />
        <di:waypoint x="1312" y="120" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_Rejected_di" bpmnElement="Flow_Rejected">
        <di:waypoint x="1208" y="220" />
        <di:waypoint x="1260" y="220" />
        <di:waypoint x="1260" y="270" />
        <di:waypoint x="1312" y="270" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_Timeout_di" bpmnElement="Flow_Timeout">
        <di:waypoint x="1208" y="320" />
        <di:waypoint x="1260" y="320" />
        <di:waypoint x="1260" y="270" />
        <di:waypoint x="1312" y="270" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>
