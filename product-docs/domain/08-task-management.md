# Domain Specification: Task Management System

**Version**: 2.0
**Last Updated**: 2025-01-16
**Status**: Draft
**Owner**: Engineering Team

> **v2.0 Update**: Added SERVICE_ORDER_RISK_REVIEW task type for AI-powered risk assessment workflow

---

## Table of Contents

1. [Overview](#overview)
2. [Business Context](#business-context)
3. [Core Concepts](#core-concepts)
4. [Task Types](#task-types)
5. [Task Lifecycle](#task-lifecycle)
6. [Task Assignment & Routing](#task-assignment--routing)
7. [Task Escalation & SLAs](#task-escalation--slas)
8. [Task Dashboard & Filtering](#task-dashboard--filtering)
9. [Integration Points](#integration-points)
10. [Business Rules](#business-rules)
11. [Data Model](#data-model)
12. [API Contract](#api-contract)
13. [Event Schema](#event-schema)
14. [NFRs & Quality Attributes](#nfrs--quality-attributes)
15. [Security & RBAC](#security--rbac)
16. [Open Questions](#open-questions)

---

## 1. Overview

### Purpose

The **Task Management System** provides a centralized workflow for managing operator interventions required throughout the service order lifecycle. Tasks are automatically generated by the system when exceptional situations occur (e.g., payment failures, quality issues, provider disputes) and require human operator review, decision-making, or corrective action.

### Objectives

- **Automated Task Generation**: System automatically creates tasks when exceptional conditions are detected
- **Prioritization**: Tasks are prioritized based on business impact and urgency
- **Assignment**: Tasks are routed to appropriate operators based on role, expertise, and workload
- **SLA Enforcement**: Tasks are escalated if not resolved within defined timeframes
- **Visibility**: Operators have a unified dashboard view of all pending tasks
- **Audit Trail**: Complete history of task lifecycle and operator actions

### Scope

**In Scope**:
- Task creation triggers from domain events
- Task lifecycle management (create, assign, progress, complete, cancel)
- Task prioritization and assignment rules
- SLA-based escalation workflows
- Operator dashboard and filtering
- Integration with alerts, notifications, and service order workflows

**Out of Scope**:
- General ticketing system for customer support (separate system)
- Provider task management (providers have separate mobile app workflows)
- Automated task resolution (all tasks require operator intervention by definition)

---

## 2. Business Context

### Problem Statement

Throughout the service order lifecycle, exceptional situations arise that require human operator intervention:

1. **Pre-Flight Failures**: Payment or product delivery issues block service execution
2. **Quality Issues**: Customers sign WCF with reserves, indicating incomplete or poor-quality work
3. **Contract Issues**: Customers refuse to sign pre-service contracts or WCF
4. **Provider Disputes**: Providers contest invoices or refuse payment terms
5. **Incomplete Work**: Providers check out with job marked incomplete
6. **Assignment Failures**: No providers available or all providers reject offers

Without a centralized task management system, these issues are handled ad-hoc via emails, spreadsheets, or verbal communication, leading to:
- Missed SLAs and delayed resolution
- Lack of visibility into pending issues
- Inconsistent handling of similar situations
- No audit trail of operator actions

### Business Value

- **Reduced Resolution Time**: Tasks are routed to the right operator immediately
- **Improved SLA Compliance**: Automatic escalation ensures urgent tasks are not missed
- **Increased Transparency**: Managers can monitor team workload and task metrics
- **Better Customer Experience**: Issues are resolved faster and more consistently
- **Data-Driven Insights**: Task metrics reveal recurring problems and process improvements

### User Personas

**Primary Users**:
- **Service Operators**: Handle routine tasks (rescheduling, minor quality issues)
- **Senior Service Operators**: Handle complex tasks (payment disputes, major quality issues)
- **Team Leads/Managers**: Monitor team performance, reassign tasks, handle escalations

**Secondary Users**:
- **System Administrators**: Configure task assignment rules and SLA thresholds
- **Quality Managers**: Review task resolution patterns and quality metrics

---

## 3. Core Concepts

### Task

A **Task** represents a unit of work requiring operator intervention to resolve an exceptional situation in the service order lifecycle.

**Key Attributes**:
- **Task ID**: Unique identifier
- **Task Type**: Category of the exceptional situation (see Task Types section)
- **Priority**: Business urgency (CRITICAL, URGENT, HIGH, MEDIUM, LOW)
- **Status**: Lifecycle state (OPEN, ASSIGNED, IN_PROGRESS, COMPLETED, CANCELLED)
- **Service Order ID**: The service order requiring intervention
- **Context**: Additional data needed to resolve the task (e.g., WCF reserves, payment details)
- **Assigned To**: Operator currently responsible for the task
- **SLA**: Deadline for task completion
- **Created At**: Task creation timestamp
- **Resolved At**: Task completion timestamp

### Task Priority

Tasks are assigned one of five priority levels, which determine SLA targets and escalation rules:

| Priority | Description | SLA Target | Use Cases |
|----------|-------------|------------|-----------|
| **CRITICAL** | Immediate action required, service execution blocked | 2 hours | Pre-flight failure on same-day appointment |
| **URGENT** | Action required today, risk of SLA breach | 4 hours | WCF not signed 24h before payment deadline |
| **HIGH** | Action required within 1 business day | 8 hours | WCF signed with major reserves |
| **MEDIUM** | Action required within 2 business days | 16 hours | Provider invoice contested |
| **LOW** | Action required within 1 week | 40 hours | Minor documentation issues |

### Task Assignment

Tasks are assigned to operators based on:
1. **Role/Permissions**: Operator must have permission to handle the task type
2. **Expertise**: Operator has specialized skills (e.g., payment disputes, quality issues)
3. **Workload**: Current number of assigned tasks and task priorities
4. **Availability**: Operator is online and not marked as unavailable
5. **Country/BU**: Operator manages service orders in the same country/business unit

### Task Escalation

If a task is not resolved within the SLA target, it is **escalated**:
1. **First Escalation**: Notify assigned operator's manager
2. **Second Escalation**: Reassign to senior operator or team lead
3. **Third Escalation**: Notify senior management and flag for immediate resolution

---

## 4. Task Types

### 4.1 PRE_FLIGHT_FAILURE

**Trigger**: Go Execution pre-flight check fails (payment or product delivery incomplete)

**Context Data**:
```typescript
interface PreFlightFailureContext {
  goExecutionStatus: 'NOT_OK_PAYMENT' | 'NOT_OK_DELIVERY' | 'NOT_OK_BOTH';
  paymentStatus: PaymentStatus;
  deliveryStatus: DeliveryStatus;
  scheduledDate: string; // ISO 8601 date of scheduled appointment
  timeUntilAppointment: number; // Hours until appointment
  blockingReasons: string[];
}
```

**Priority Determination**:
- **CRITICAL**: Appointment within 4 hours
- **URGENT**: Appointment within 24 hours
- **HIGH**: Appointment within 48 hours
- **MEDIUM**: Appointment beyond 48 hours

**Operator Actions**:
1. **Contact Customer**: Verify payment status or delivery timeline
2. **Reschedule Appointment**: If payment/delivery delayed, reschedule service
3. **Manual Override**: If payment confirmed externally, manually override check
4. **Cancel Service Order**: If customer unresponsive or refuses to pay

**Success Criteria**: Go Execution status changed to `OK` or `MANUALLY_OVERRIDDEN`, or service order rescheduled/cancelled

---

### 4.2 RESOLVE_WCF_RESERVES

**Trigger**: Customer signs WCF with reserves (quality issues reported)

**Context Data**:
```typescript
interface WCFReservesContext {
  wcfId: string;
  reserves: CustomerReserve[];
  totalReserves: number;
  severityBreakdown: {
    MINOR: number;
    MODERATE: number;
    MAJOR: number;
  };
  customerComments: string;
}

interface CustomerReserve {
  id: string;
  description: string;
  severity: 'MINOR' | 'MODERATE' | 'MAJOR';
  photos: string[]; // URLs to evidence photos
}
```

**Priority Determination**:
- **URGENT**: 1+ MAJOR reserves
- **HIGH**: 3+ MODERATE reserves or 1-2 MODERATE reserves
- **MEDIUM**: Only MINOR reserves

**Operator Actions**:
1. **Review Reserves**: Examine customer comments and photos
2. **Contact Provider**: Get provider's explanation of reported issues
3. **Schedule Re-Intervention**: If quality issues confirmed, schedule provider return visit
4. **Negotiate Resolution**: Determine if partial refund, discount, or other compensation warranted
5. **Mark Reserves Resolved**: Document resolution and close reserves
6. **Authorize Payment**: Once all reserves resolved, authorize provider payment

**Success Criteria**: All reserves marked as resolved, payment authorized or compensation agreed

---

### 4.3 WCF_NOT_SIGNED

**Trigger**: Customer does not sign WCF within expiry period (7 days) or explicitly declines

**Context Data**:
```typescript
interface WCFNotSignedContext {
  wcfId: string;
  wcfStatus: 'NOT_SIGNED' | 'EXPIRED';
  sentAt: string; // ISO 8601 timestamp
  expiresAt: string; // ISO 8601 timestamp
  viewedAt?: string; // If customer opened WCF link
  lastReminderSentAt?: string; // Last reminder notification
  declineReason?: string; // If customer explicitly declined
}
```

**Priority Determination**:
- **URGENT**: WCF expired and payment deadline approaching
- **HIGH**: Customer explicitly declined WCF
- **MEDIUM**: WCF expired but no immediate payment deadline

**Operator Actions**:
1. **Contact Customer**: Understand reason for not signing (e.g., quality issues, dispute)
2. **Regenerate WCF**: If customer didn't receive or lost link, regenerate and resend
3. **Escalate to Manager**: If customer disputes work quality or refuses to sign
4. **Withhold Payment**: Do not authorize provider payment until resolved
5. **Initiate Claims Process**: If significant dispute, escalate to claims/legal team

**Success Criteria**: WCF signed, or dispute resolution process initiated

---

### 4.4 INVOICE_CONTESTED

**Trigger**: Provider contests pro forma invoice (disputes amount, line items, or terms)

**Context Data**:
```typescript
interface InvoiceContestedContext {
  invoiceId: string;
  invoiceNumber: string;
  invoicedAmount: number;
  contestedAmount: number;
  contestReason: string;
  contestedLineItems: InvoiceLineItem[];
  providerComments: string;
  providerEvidence: string[]; // URLs to supporting documents
}

interface InvoiceLineItem {
  description: string;
  quantity: number;
  unitPrice: number;
  totalPrice: number;
  contested: boolean;
}
```

**Priority Determination**:
- **HIGH**: Contested amount > 500 EUR or > 30% of invoice total
- **MEDIUM**: Contested amount 100-500 EUR or 10-30% of invoice total
- **LOW**: Contested amount < 100 EUR or < 10% of invoice total

**Operator Actions**:
1. **Review Contest**: Examine provider's reason and evidence
2. **Verify Contract Terms**: Check service order contract and agreed pricing
3. **Contact Provider**: Discuss contested items and seek resolution
4. **Adjust Invoice**: If provider is correct, generate revised invoice
5. **Reject Contest**: If contest is unjustified, explain and maintain original invoice
6. **Escalate to Finance**: If complex pricing dispute, involve finance team

**Success Criteria**: Invoice accepted by provider (signed), or revised invoice generated and accepted

---

### 4.5 INCOMPLETE_JOB

**Trigger**: Provider checks out with job marked as `INCOMPLETE`

**Context Data**:
```typescript
interface IncompleteJobContext {
  checkoutId: string;
  checkoutTimestamp: string; // ISO 8601
  incompleteReason: string;
  providerComments: string;
  workProgress: number; // Percentage (0-100)
  missingSteps: string[]; // Checklist items not completed
  followUpRequired: boolean;
  providerRequestedReschedule: boolean;
  suggestedRescheduleDate?: string;
}
```

**Priority Determination**:
- **HIGH**: Work progress < 50%, customer waiting for completion
- **MEDIUM**: Work progress 50-90%, follow-up required
- **LOW**: Work progress > 90%, minor items remain

**Operator Actions**:
1. **Review Checkout**: Examine provider's explanation and work progress
2. **Contact Customer**: Verify customer is aware of incomplete work
3. **Schedule Follow-Up**: Create new service order for completion (if needed)
4. **Adjust Provider Payment**: Determine if partial payment warranted or hold full payment
5. **Quality Review**: If pattern of incomplete jobs, flag provider for quality review

**Success Criteria**: Follow-up appointment scheduled, or incomplete work documented and payment terms adjusted

---

### 4.6 UNASSIGNED_JOB

**Trigger**: Service order cannot be assigned to any provider (all rejected offers or no candidates found)

**Context Data**:
```typescript
interface UnassignedJobContext {
  assignmentAttempts: number;
  lastAttemptTimestamp: string; // ISO 8601
  noProvidersReason: 'NO_CAPACITY' | 'NO_QUALIFIED_PROVIDERS' | 'ALL_REJECTED';
  providerOffers: ProviderOfferSummary[];
  scheduledDate: string; // ISO 8601 date
  timeUntilAppointment: number; // Hours
}

interface ProviderOfferSummary {
  providerId: string;
  providerName: string;
  offeredAt: string;
  status: 'PENDING' | 'REJECTED' | 'EXPIRED';
  rejectionReason?: string;
}
```

**Priority Determination**:
- **CRITICAL**: Appointment within 24 hours, no provider assigned
- **URGENT**: Appointment within 48 hours
- **HIGH**: Appointment within 1 week
- **MEDIUM**: Appointment beyond 1 week

**Operator Actions**:
1. **Review Assignment Funnel**: Understand why no providers available/qualified
2. **Expand Search Radius**: Increase distance filter to find more candidates
3. **Adjust Pricing**: If all rejected due to price, consider increasing provider compensation
4. **Contact Providers Directly**: Call top providers to negotiate acceptance
5. **Reschedule Appointment**: If no providers available on date, reschedule to later date
6. **Escalate to Capacity Manager**: If systemic capacity issue, involve capacity planning team

**Success Criteria**: Provider assigned and offer accepted, or appointment rescheduled

---

### 4.7 CONTRACT_NOT_SIGNED

**Trigger**: Customer does not sign pre-service contract within expiry period (7 days) or explicitly declines

**Context Data**:
```typescript
interface ContractNotSignedContext {
  contractId: string;
  contractType: 'INDIVIDUAL' | 'BUNDLE';
  serviceOrderIds: string[];
  sentAt: string; // ISO 8601
  expiresAt: string; // ISO 8601
  viewedAt?: string;
  declineReason?: string;
}
```

**Priority Determination**:
- **HIGH**: Contract expired and appointment within 7 days
- **MEDIUM**: Contract expired and appointment beyond 7 days
- **LOW**: Customer explicitly declined but appointment far in future

**Operator Actions**:
1. **Contact Customer**: Understand reason for not signing
2. **Regenerate Contract**: If customer lost link or didn't receive
3. **Adjust Contract Terms**: If customer has concerns about terms
4. **Cancel Service Order**: If customer no longer wants service
5. **Block Provider Assignment**: Do not assign provider until contract signed

**Success Criteria**: Contract signed, contract terms renegotiated, or service order cancelled

---

### 4.8 PAYMENT_FAILED

**Trigger**: Customer payment authorization or charge fails

**Context Data**:
```typescript
interface PaymentFailedContext {
  paymentAttemptId: string;
  failureReason: string;
  paymentMethod: string;
  attemptedAmount: number;
  attemptTimestamp: string; // ISO 8601
  retryCount: number;
  scheduledDate: string; // Service appointment date
}
```

**Priority Determination**:
- **CRITICAL**: Appointment within 24 hours, payment required before service
- **URGENT**: Appointment within 48 hours
- **HIGH**: Appointment within 1 week

**Operator Actions**:
1. **Contact Customer**: Notify of payment failure and request alternate payment method
2. **Retry Payment**: If customer confirms card issue resolved, retry charge
3. **Reschedule Appointment**: If customer needs time to resolve payment, reschedule
4. **Cancel Service Order**: If customer cannot/will not pay

**Success Criteria**: Payment successful, or appointment rescheduled/cancelled

---

### 4.9 DOCUMENT_REVIEW

**Trigger**: Provider uploads documents (certifications, compliance docs) requiring operator review

**Context Data**:
```typescript
interface DocumentReviewContext {
  documentId: string;
  documentType: 'CERTIFICATION' | 'INSURANCE' | 'LICENSE' | 'COMPLIANCE' | 'OTHER';
  uploadedBy: string; // Provider ID
  uploadedAt: string; // ISO 8601
  expiresAt?: string; // If document has expiry date
  documentUrl: string;
}
```

**Priority Determination**:
- **HIGH**: Certification/license expires within 7 days
- **MEDIUM**: Document required for provider onboarding or compliance audit
- **LOW**: Non-urgent document review

**Operator Actions**:
1. **Review Document**: Verify authenticity, completeness, and validity
2. **Approve Document**: Mark as approved in system
3. **Reject Document**: Request provider resubmit with corrections
4. **Flag for Compliance**: If document raises compliance concerns, escalate

**Success Criteria**: Document approved or rejected with feedback

---

### 4.10 QUALITY_ALERT

**Trigger**: Service order quality metrics fall below threshold (low CSAT, repeated reserves, etc.)

**Context Data**:
```typescript
interface QualityAlertContext {
  alertType: 'LOW_CSAT' | 'REPEATED_RESERVES' | 'MULTIPLE_INCOMPLETE' | 'CUSTOMER_COMPLAINT';
  serviceOrderId: string;
  providerId: string;
  qualityMetrics: {
    csatScore?: number; // 1-5
    reserveCount?: number;
    incompleteJobCount?: number;
  };
  customerFeedback?: string;
}
```

**Priority Determination**:
- **URGENT**: Customer complaint or CSAT < 2.0
- **HIGH**: CSAT 2.0-3.0 or 3+ reserves in last 30 days
- **MEDIUM**: CSAT 3.0-4.0 or 2 incomplete jobs

**Operator Actions**:
1. **Review Service Order**: Examine service execution details
2. **Contact Customer**: Apologize and understand concerns
3. **Contact Provider**: Discuss quality issues and corrective actions
4. **Offer Compensation**: If warranted, offer refund/discount to customer
5. **Flag Provider**: If pattern of quality issues, escalate to provider management

**Success Criteria**: Customer satisfaction restored, or provider corrective action plan documented

---

### 4.11 SERVICE_ORDER_RISK_REVIEW (v2.0)

**Trigger**: AI Risk Assessment Scorer identifies service order with HIGH or CRITICAL risk level

**Context Data**:
```typescript
interface ServiceOrderRiskReviewContext {
  serviceOrderId: string;
  riskLevel: 'HIGH' | 'CRITICAL';
  riskScore: number; // 0-100
  riskFactors: RiskFactor[];
  triggeredBy: string; // 'BATCH_JOB' | 'EVENT_CLAIM_FILED' | 'EVENT_MULTIPLE_RESCHEDULES' | etc.
  assessedAt: string; // ISO 8601 timestamp
  recommendedActions: string[];
}

interface RiskFactor {
  factor: string; // 'MULTIPLE_CLAIMS', 'MULTIPLE_RESCHEDULES', 'LOW_PROVIDER_QUALITY', etc.
  description: string; // Human-readable description
  weight: number; // 0.0-1.0 (contribution to risk score)
  severity: 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL';
}
```

**Priority Determination**:
- **CRITICAL**: Risk level = CRITICAL (4-hour SLA)
- **HIGH**: Risk level = HIGH (8-hour SLA)

**Operator Actions**:
1. **Review Risk Factors**: Examine the specific risk factors identified by AI model
2. **Contact Customer**: Proactively call customer to confirm appointment and requirements
3. **Review Service History**: Check for patterns in claims, reschedules, or provider issues
4. **Verify Provider Assignment**: Consider reassigning to higher-rated provider if current provider quality score is low
5. **Add Special Instructions**: Document any special handling requirements for technician
6. **Acknowledge Risk**: Formally acknowledge awareness of risk (required before check-in for HIGH/CRITICAL)
7. **Escalate if Needed**: If risk factors cannot be mitigated, escalate to senior operator

**Success Criteria**:
- Operator has acknowledged the risk (status changed to `acknowledged`)
- Recommended actions have been reviewed and addressed
- If reassignment needed, new provider assigned
- Special instructions added to service order if required

**Business Rules**:
- **BR-RISK-TASK-001**: Task is auto-created when AI Risk Scorer assigns HIGH or CRITICAL risk
- **BR-RISK-TASK-002**: Task SLA is 4 hours for CRITICAL, 8 hours for HIGH
- **BR-RISK-TASK-003**: Task is auto-assigned to project's responsible operator (Pilote du Chantier)
- **BR-RISK-TASK-004**: Service order check-in is BLOCKED until risk is acknowledged by operator
- **BR-RISK-TASK-005**: If task SLA breached, escalate to senior operator and notify team lead

**Integration Points**:
- **AI Risk Scorer**: Receives risk assessment results from domain event `projects.risk.assessed`
- **Service Order Domain**: Calls `serviceOrder.acknowledgeRisk()` when operator completes review
- **Assignment System**: May trigger reassignment if operator decides current provider unsuitable
- **Notification System**: Sends alert to responsible operator when HIGH/CRITICAL risk detected

**Example Scenario**:

```
1. AI Risk Scorer runs daily batch at midnight
2. Service Order SO-2025-001 (kitchen installation, scheduled in 2 days) scored as HIGH risk:
   - Risk Score: 75/100
   - Risk Factors:
     * MULTIPLE_RESCHEDULES (rescheduled 3 times) - CRITICAL severity
     * LOW_PROVIDER_QUALITY (provider score 55/100) - HIGH severity
     * INCOMPLETE_CHECKOUT (past checkout incomplete) - MEDIUM severity

3. Domain event emitted: projects.risk.assessed
4. Task Management System creates task:
   - Type: SERVICE_ORDER_RISK_REVIEW
   - Priority: HIGH (8-hour SLA)
   - Assigned To: operator_user_123 (project's responsible operator)
   - Due: 8 hours from now

5. Notification sent to operator: "HIGH Risk Detected on SO-2025-001"

6. Operator reviews task:
   - Sees risk factors: multiple reschedules, low provider quality, incomplete checkout
   - Calls customer to confirm appointment and special requirements
   - Reviews provider's history: sees 55/100 quality score and pattern of issues
   - Decides to reassign to higher-rated provider (score 92/100)
   - Adds special instruction: "Customer prefers morning slots, ensure all tools available"
   - Acknowledges risk (clicks "Acknowledge Risk" button)

7. Task marked as COMPLETED
8. Service order updated: risk_acknowledged_by = operator_user_123, risk_acknowledged_at = NOW()
9. Check-in now allowed (risk acknowledged)
```

---

## 5. Task Lifecycle

### State Machine

```
         ┌─────────────────────────────────────────┐
         │                                         │
         │                                         ▼
   ┌──────────┐    assign    ┌──────────┐   start   ┌──────────────┐
   │   OPEN   ├─────────────►│ ASSIGNED ├──────────►│ IN_PROGRESS  │
   └────┬─────┘              └────┬─────┘           └──────┬───────┘
        │                         │                        │
        │ cancel                  │ cancel                 │ complete
        │                         │                        │
        │                         ▼                        ▼
        │                    ┌──────────┐           ┌──────────┐
        └───────────────────►│ CANCELLED│           │COMPLETED │
                             └──────────┘           └──────────┘
```

### Status Definitions

| Status | Description | Allowed Transitions |
|--------|-------------|---------------------|
| **OPEN** | Task created, awaiting assignment | → ASSIGNED, CANCELLED |
| **ASSIGNED** | Task assigned to operator, not started | → IN_PROGRESS, OPEN (unassign), CANCELLED |
| **IN_PROGRESS** | Operator actively working on task | → COMPLETED, CANCELLED |
| **COMPLETED** | Task resolved successfully | (terminal state) |
| **CANCELLED** | Task no longer relevant or duplicate | (terminal state) |

### Lifecycle Events

**Task Created**:
```typescript
interface TaskCreatedEvent {
  eventType: 'TASK_CREATED';
  taskId: string;
  taskType: TaskType;
  priority: TaskPriority;
  serviceOrderId: string;
  context: any; // Task-type-specific context
  createdAt: string; // ISO 8601
  slaDeadline: string; // ISO 8601
}
```

**Task Assigned**:
```typescript
interface TaskAssignedEvent {
  eventType: 'TASK_ASSIGNED';
  taskId: string;
  assignedTo: string; // Operator user ID
  assignedBy: string; // 'SYSTEM' or operator user ID
  assignedAt: string; // ISO 8601
}
```

**Task Started**:
```typescript
interface TaskStartedEvent {
  eventType: 'TASK_STARTED';
  taskId: string;
  startedBy: string; // Operator user ID
  startedAt: string; // ISO 8601
}
```

**Task Completed**:
```typescript
interface TaskCompletedEvent {
  eventType: 'TASK_COMPLETED';
  taskId: string;
  completedBy: string; // Operator user ID
  completedAt: string; // ISO 8601
  resolutionNotes: string;
  resolutionTime: number; // Minutes from creation to completion
  withinSLA: boolean;
}
```

**Task Escalated**:
```typescript
interface TaskEscalatedEvent {
  eventType: 'TASK_ESCALATED';
  taskId: string;
  escalationLevel: 1 | 2 | 3;
  escalatedAt: string; // ISO 8601
  escalationReason: 'SLA_BREACH' | 'MANUAL';
  notifiedUsers: string[]; // User IDs of escalation recipients
}
```

**Task Cancelled**:
```typescript
interface TaskCancelledEvent {
  eventType: 'TASK_CANCELLED';
  taskId: string;
  cancelledBy: string; // Operator user ID
  cancelledAt: string; // ISO 8601
  cancellationReason: string;
}
```

---

## 6. Task Assignment & Routing

### Assignment Modes

**1. Automatic Assignment**

When a task is created, the system automatically assigns it to the most suitable operator based on:

```typescript
interface AssignmentScore {
  operatorId: string;
  score: number; // 0-100
  breakdown: {
    roleMatch: number; // 0-30 points (has required permissions)
    expertiseMatch: number; // 0-25 points (has handled this task type before)
    workloadScore: number; // 0-25 points (fewer current tasks = higher score)
    availabilityScore: number; // 0-10 points (online, not busy)
    tenantMatch: number; // 0-10 points (manages same country/BU)
  };
}
```

**Scoring Algorithm**:

```typescript
async function scoreOperatorForTask(
  operatorId: string,
  task: Task
): Promise<AssignmentScore> {
  const operator = await operatorRepository.findById(operatorId);

  // 1. Role Match (30 points max)
  const requiredPermissions = getRequiredPermissionsForTaskType(task.type);
  const hasPermissions = operator.permissions.includesAll(requiredPermissions);
  const roleMatch = hasPermissions ? 30 : 0;

  // 2. Expertise Match (25 points max)
  const pastTasksOfType = await taskRepository.countCompletedByOperatorAndType(
    operatorId,
    task.type
  );
  const expertiseMatch = Math.min(25, pastTasksOfType * 5); // 5 points per past task, cap at 25

  // 3. Workload Score (25 points max)
  const currentTasks = await taskRepository.countActiveByOperator(operatorId);
  const workloadScore = Math.max(0, 25 - currentTasks * 5); // -5 points per active task

  // 4. Availability Score (10 points max)
  const isOnline = operator.status === 'ONLINE';
  const isBusy = operator.currentTaskCount > 3;
  const availabilityScore = isOnline && !isBusy ? 10 : 0;

  // 5. Tenant Match (10 points max)
  const tenantMatch = operator.managedCountries.includes(task.countryCode) ? 10 : 0;

  const totalScore =
    roleMatch +
    expertiseMatch +
    workloadScore +
    availabilityScore +
    tenantMatch;

  return {
    operatorId,
    score: totalScore,
    breakdown: { roleMatch, expertiseMatch, workloadScore, availabilityScore, tenantMatch }
  };
}
```

**Assignment Selection**:

```typescript
async function autoAssignTask(task: Task): Promise<void> {
  // Get all eligible operators
  const operators = await operatorRepository.findEligibleForTaskType(task.type);

  // Score each operator
  const scores = await Promise.all(
    operators.map(op => scoreOperatorForTask(op.id, task))
  );

  // Sort by score descending
  scores.sort((a, b) => b.score - a.score);

  // Assign to top scorer
  if (scores.length > 0 && scores[0].score >= 40) {
    await assignTaskToOperator(task.id, scores[0].operatorId, 'SYSTEM');
  } else {
    // No suitable operator, leave task in OPEN state for manual assignment
    await alertService.notifyNoOperatorAvailable(task);
  }
}
```

**2. Manual Assignment**

Managers or senior operators can manually assign tasks to specific operators, overriding automatic assignment.

**3. Self-Assignment (Task Pool)**

For certain task types (e.g., DOCUMENT_REVIEW), operators can browse unassigned tasks and self-assign from a task pool.

---

### Assignment Rules by Task Type

| Task Type | Assignment Mode | Assignment Pool |
|-----------|-----------------|-----------------|
| PRE_FLIGHT_FAILURE | Automatic | Service operators (same country) |
| RESOLVE_WCF_RESERVES | Automatic | Quality operators (same country) |
| WCF_NOT_SIGNED | Automatic | Senior service operators |
| INVOICE_CONTESTED | Automatic | Finance operators |
| INCOMPLETE_JOB | Automatic | Quality operators (same country) |
| UNASSIGNED_JOB | Automatic | Capacity managers (same country) |
| CONTRACT_NOT_SIGNED | Automatic | Service operators (same country) |
| PAYMENT_FAILED | Automatic | Payment operators |
| DOCUMENT_REVIEW | Self-Assignment | Compliance operators |
| QUALITY_ALERT | Automatic | Quality managers |

---

## 7. Task Escalation & SLAs

### SLA Targets by Priority

| Priority | Target Resolution Time | First Escalation | Second Escalation | Third Escalation |
|----------|------------------------|------------------|-------------------|------------------|
| CRITICAL | 2 hours | 1 hour | 1.5 hours | 2 hours |
| URGENT | 4 hours | 2 hours | 3 hours | 4 hours |
| HIGH | 8 hours | 4 hours | 6 hours | 8 hours |
| MEDIUM | 16 hours | 8 hours | 12 hours | 16 hours |
| LOW | 40 hours (5 days) | 20 hours | 30 hours | 40 hours |

### Escalation Actions

**First Escalation** (at 50% of SLA):
- Send notification to assigned operator: "Task {taskId} is approaching SLA (50% time elapsed)"
- Send notification to operator's manager: "Task {taskId} assigned to {operator} requires attention"

**Second Escalation** (at 75% of SLA):
- Send urgent notification to assigned operator
- Send notification to senior operator or team lead
- Optionally reassign task to more experienced operator

**Third Escalation** (at 100% of SLA - SLA BREACH):
- Mark task as SLA breached
- Send critical alert to senior management
- Automatically reassign to team lead or manager
- Log SLA breach incident for metrics

### Escalation Workflow

```typescript
async function checkAndEscalateTask(task: Task): Promise<void> {
  const now = new Date();
  const createdAt = new Date(task.createdAt);
  const slaDeadline = new Date(task.slaDeadline);

  const elapsedMinutes = (now.getTime() - createdAt.getTime()) / (1000 * 60);
  const totalMinutes = (slaDeadline.getTime() - createdAt.getTime()) / (1000 * 60);
  const percentElapsed = (elapsedMinutes / totalMinutes) * 100;

  if (percentElapsed >= 100 && task.escalationLevel < 3) {
    // SLA BREACH - Third Escalation
    await escalateTask(task, 3, 'SLA_BREACH');
    await notificationService.sendCriticalAlert({
      recipients: await getUsersByRole('SENIOR_MANAGEMENT'),
      message: `CRITICAL: Task ${task.id} has breached SLA`,
      task
    });
    await reassignToTeamLead(task);
  } else if (percentElapsed >= 75 && task.escalationLevel < 2) {
    // Second Escalation
    await escalateTask(task, 2, 'SLA_AT_RISK');
    await notificationService.sendEscalation({
      recipients: [task.assignedTo, ...await getUsersByRole('SENIOR_OPERATOR')],
      message: `Task ${task.id} is at 75% of SLA (${elapsedMinutes.toFixed(0)}/${totalMinutes.toFixed(0)} minutes)`,
      task
    });
  } else if (percentElapsed >= 50 && task.escalationLevel < 1) {
    // First Escalation
    await escalateTask(task, 1, 'SLA_WARNING');
    const manager = await getOperatorManager(task.assignedTo);
    await notificationService.sendEscalation({
      recipients: [task.assignedTo, manager.id],
      message: `Task ${task.id} is at 50% of SLA, please prioritize`,
      task
    });
  }
}

async function escalateTask(
  task: Task,
  level: 1 | 2 | 3,
  reason: string
): Promise<void> {
  await taskRepository.update(task.id, {
    escalationLevel: level,
    escalatedAt: new Date()
  });

  await eventPublisher.publish({
    topic: 'tasks.task.escalated',
    key: task.id,
    value: {
      eventType: 'TASK_ESCALATED',
      taskId: task.id,
      escalationLevel: level,
      escalatedAt: new Date().toISOString(),
      escalationReason: reason
    }
  });
}
```

### SLA Pause/Resume

In certain situations, the SLA clock can be paused:

**Pause Triggers**:
- Waiting for customer response (operator sent email/call, awaiting reply)
- Waiting for external system response (payment gateway, ERP, etc.)
- Outside business hours (if configured for task type)

**Resume Triggers**:
- Customer responds
- External system responds
- Business hours resume

```typescript
interface SLATracking {
  taskId: string;
  createdAt: string; // ISO 8601
  slaDeadline: string; // ISO 8601
  isPaused: boolean;
  pausedAt?: string; // ISO 8601
  pauseReason?: string;
  totalPausedMinutes: number; // Cumulative pause time
}

async function pauseSLA(taskId: string, reason: string): Promise<void> {
  await taskRepository.update(taskId, {
    slaPaused: true,
    slaPausedAt: new Date(),
    slaPauseReason: reason
  });
}

async function resumeSLA(taskId: string): Promise<void> {
  const task = await taskRepository.findById(taskId);
  const pausedMinutes = (new Date().getTime() - new Date(task.slaPausedAt).getTime()) / (1000 * 60);

  // Extend SLA deadline by paused duration
  const newDeadline = new Date(task.slaDeadline);
  newDeadline.setMinutes(newDeadline.getMinutes() + pausedMinutes);

  await taskRepository.update(taskId, {
    slaPaused: false,
    slaDeadline: newDeadline,
    totalPausedMinutes: task.totalPausedMinutes + pausedMinutes
  });
}
```

---

## 8. Task Dashboard & Filtering

### Dashboard Views

**Operator View** (for individual operators):

```typescript
interface OperatorDashboard {
  myTasks: {
    inProgress: Task[];
    assigned: Task[];
    total: number;
  };
  upcomingSLAs: Task[]; // Tasks with SLA deadline within next 4 hours
  escalated: Task[]; // Tasks that have been escalated
  recentlyCompleted: Task[]; // Tasks completed in last 24 hours
  statistics: {
    completedToday: number;
    averageResolutionTime: number; // Minutes
    slaComplianceRate: number; // Percentage
  };
}
```

**Team View** (for managers):

```typescript
interface TeamDashboard {
  teamTasks: {
    open: Task[];
    assigned: Task[];
    inProgress: Task[];
    total: number;
  };
  tasksByOperator: {
    operatorId: string;
    operatorName: string;
    activeTasks: number;
    slaBreaches: number;
  }[];
  slaBreaches: Task[]; // All tasks with SLA breach
  escalatedTasks: Task[]; // All escalated tasks
  statistics: {
    completedLast24h: number;
    averageResolutionTime: number;
    slaComplianceRate: number;
    tasksByType: { taskType: TaskType; count: number }[];
  };
}
```

### Filtering & Search

Operators can filter tasks by:

**Standard Filters**:
- **Status**: OPEN, ASSIGNED, IN_PROGRESS, COMPLETED, CANCELLED
- **Priority**: CRITICAL, URGENT, HIGH, MEDIUM, LOW
- **Task Type**: Any of the 10 task types
- **Assigned To**: Specific operator or team
- **Country/BU**: Service order country or business unit
- **Date Range**: Created within date range

**Advanced Filters**:
- **SLA Status**: On track, at risk (> 50%), breached
- **Escalation Level**: 0, 1, 2, 3
- **Service Order ID**: Exact match or partial search
- **Customer ID**: All tasks for specific customer
- **Provider ID**: All tasks for specific provider

**Search**:
- Full-text search across task title, description, resolution notes

### Sorting

Tasks can be sorted by:
- **SLA Deadline** (ascending) - default for operators
- **Priority** (descending)
- **Created At** (descending)
- **Assigned At** (descending)
- **Completed At** (descending)

---

## 9. Integration Points

### 9.1 Integration with Service Orders

Tasks are tightly coupled with service orders:

- **Task Creation**: Triggered by service order events (e.g., `service_order.pre_flight_failed`)
- **Task Context**: Task links back to service order for full context
- **Task Resolution**: Task actions update service order status (e.g., mark Go Execution as OK)

**Service Order View Integration**:

When viewing a service order, operators can see:
- All tasks associated with the service order
- Active tasks requiring attention
- Completed tasks with resolution history

```typescript
// GET /api/v1/service-orders/{serviceOrderId}
interface ServiceOrderResponse {
  // ... other service order fields
  tasks: {
    active: Task[];
    completed: Task[];
    totalTasks: number;
  };
}
```

### 9.2 Integration with Alerts

Tasks are created from critical alerts:

**Alert → Task Conversion**:

```typescript
async function handleCriticalAlert(alert: Alert): Promise<void> {
  if (alert.severity === 'CRITICAL' || alert.severity === 'HIGH') {
    const task = await taskService.createTask({
      type: mapAlertTypeToTaskType(alert.type),
      priority: mapAlertSeverityToTaskPriority(alert.severity),
      serviceOrderId: alert.serviceOrderId,
      context: alert.context,
      createdBy: 'SYSTEM'
    });

    // Link alert to task
    await alertRepository.update(alert.id, {
      taskId: task.id,
      status: 'TASK_CREATED'
    });
  }
}
```

**Alert-to-Task Mapping**:

| Alert Type | Task Type |
|------------|-----------|
| PRE_FLIGHT_CHECK_FAILED | PRE_FLIGHT_FAILURE |
| WCF_SIGNED_WITH_RESERVES | RESOLVE_WCF_RESERVES |
| WCF_EXPIRED | WCF_NOT_SIGNED |
| INVOICE_DISPUTED | INVOICE_CONTESTED |
| CHECKOUT_INCOMPLETE | INCOMPLETE_JOB |
| ASSIGNMENT_FAILED | UNASSIGNED_JOB |
| CONTRACT_EXPIRED | CONTRACT_NOT_SIGNED |
| PAYMENT_DECLINED | PAYMENT_FAILED |
| LOW_CSAT_SCORE | QUALITY_ALERT |

### 9.3 Integration with Notifications

Tasks trigger notifications at key lifecycle points:

**Notification Triggers**:

1. **Task Created & Assigned**: Notify assigned operator
2. **Task Escalated**: Notify operator + manager
3. **Task SLA Approaching**: Notify operator at 50%, 75% SLA
4. **Task Completed**: Notify stakeholders (customer, provider, manager)

**Notification Channels**:
- **In-App**: Notification bell in operator web app
- **Email**: For escalations and SLA breaches
- **SMS**: For CRITICAL tasks only

```typescript
async function sendTaskNotification(
  task: Task,
  event: 'CREATED' | 'ASSIGNED' | 'ESCALATED' | 'SLA_WARNING' | 'COMPLETED'
): Promise<void> {
  const operator = await userRepository.findById(task.assignedTo);

  const notification: Notification = {
    userId: operator.id,
    type: 'TASK',
    title: getNotificationTitle(task, event),
    message: getNotificationMessage(task, event),
    actionUrl: `/tasks/${task.id}`,
    priority: task.priority,
    channels: getNotificationChannels(task.priority, event)
  };

  await notificationService.send(notification);
}

function getNotificationChannels(priority: TaskPriority, event: string): string[] {
  if (priority === 'CRITICAL') {
    return ['IN_APP', 'EMAIL', 'SMS'];
  } else if (priority === 'URGENT' || event === 'ESCALATED') {
    return ['IN_APP', 'EMAIL'];
  } else {
    return ['IN_APP'];
  }
}
```

### 9.4 Integration with Audit Logs

All task actions are logged to the audit trail:

```typescript
interface TaskAuditLog {
  id: string;
  taskId: string;
  action: 'CREATED' | 'ASSIGNED' | 'STARTED' | 'UPDATED' | 'COMPLETED' | 'CANCELLED' | 'ESCALATED';
  performedBy: string; // User ID or 'SYSTEM'
  performedAt: string; // ISO 8601
  changes: any; // Before/after state
  notes?: string; // Operator comments
}
```

### 9.5 Integration with Analytics

Task metrics are exported to analytics platform for reporting:

**Key Metrics**:
- Task volume by type, priority, country
- Average resolution time by task type
- SLA compliance rate (overall and by task type)
- Escalation rate
- Operator performance (tasks completed, average resolution time, SLA compliance)
- Task backlog (open tasks by age)

---

## 10. Business Rules

### Task Creation Rules

**BR-TASK-001**: A task is created only when an exceptional condition occurs that requires operator intervention. Routine workflows do not create tasks.

**BR-TASK-002**: If multiple exceptional conditions occur on the same service order, separate tasks are created for each (e.g., both payment failed AND WCF not signed → 2 tasks).

**BR-TASK-003**: Duplicate tasks are prevented. If a task of the same type already exists for a service order and is not completed/cancelled, do not create a new task.

```typescript
async function createTask(input: CreateTaskInput): Promise<Task> {
  // Check for duplicate
  const existingTask = await taskRepository.findActiveByServiceOrderAndType(
    input.serviceOrderId,
    input.type
  );

  if (existingTask) {
    throw new Error(`Active task of type ${input.type} already exists for service order ${input.serviceOrderId}`);
  }

  // Create task
  const task = await taskRepository.create({
    ...input,
    status: 'OPEN',
    createdAt: new Date(),
    slaDeadline: calculateSLADeadline(input.priority, new Date())
  });

  // Auto-assign if applicable
  if (shouldAutoAssign(input.type)) {
    await autoAssignTask(task);
  }

  return task;
}
```

### Task Completion Rules

**BR-TASK-004**: A task can only be marked as COMPLETED if the underlying issue is resolved (e.g., payment received, WCF signed, reserves resolved).

**BR-TASK-005**: When a task is completed, the operator must provide resolution notes explaining what actions were taken.

**BR-TASK-006**: If a task is completed after SLA deadline, it is marked as "SLA breached" in metrics.

### Task Reassignment Rules

**BR-TASK-007**: Tasks can be reassigned by:
- The assigned operator (if they cannot handle it)
- The operator's manager
- System administrators
- Automatic escalation workflow

**BR-TASK-008**: When a task is reassigned, the previous assignee is notified and the reassignment is logged in audit trail.

### Task Cancellation Rules

**BR-TASK-009**: Tasks can be cancelled if:
- The service order is cancelled
- The underlying issue is resolved through another workflow (e.g., customer pays via alternate channel)
- The task is a duplicate

**BR-TASK-010**: Cancelled tasks must include a cancellation reason and are retained in database for audit purposes.

### Priority Override Rules

**BR-TASK-011**: Managers can override the system-assigned priority of a task (e.g., upgrade MEDIUM to URGENT based on business context).

**BR-TASK-012**: Priority changes trigger SLA recalculation and potential reassignment.

---

## 11. Data Model

### Task Entity

```typescript
interface Task {
  id: string; // UUID
  taskType: TaskType;
  priority: TaskPriority;
  status: TaskStatus;
  serviceOrderId: string; // FK to service_orders.id
  context: any; // JSON, task-type-specific context data

  // Assignment
  assignedTo?: string; // FK to users.id (operator)
  assignedBy?: string; // FK to users.id or 'SYSTEM'
  assignedAt?: string; // ISO 8601

  // SLA Tracking
  createdAt: string; // ISO 8601
  slaDeadline: string; // ISO 8601
  slaPaused: boolean;
  slaPausedAt?: string; // ISO 8601
  slaPauseReason?: string;
  totalPausedMinutes: number;

  // Escalation
  escalationLevel: 0 | 1 | 2 | 3;
  escalatedAt?: string; // ISO 8601

  // Completion
  startedAt?: string; // ISO 8601 (when operator started working)
  completedAt?: string; // ISO 8601
  completedBy?: string; // FK to users.id
  resolutionNotes?: string; // Operator comments
  resolutionTime?: number; // Minutes from creation to completion
  withinSLA: boolean; // True if completed before slaDeadline

  // Cancellation
  cancelledAt?: string; // ISO 8601
  cancelledBy?: string; // FK to users.id
  cancellationReason?: string;

  // Metadata
  countryCode: string; // ISO 3166-1 alpha-2
  businessUnit: string; // 'LM' | 'BD'
}
```

### Enums

```typescript
enum TaskType {
  PRE_FLIGHT_FAILURE = 'PRE_FLIGHT_FAILURE',
  RESOLVE_WCF_RESERVES = 'RESOLVE_WCF_RESERVES',
  WCF_NOT_SIGNED = 'WCF_NOT_SIGNED',
  INVOICE_CONTESTED = 'INVOICE_CONTESTED',
  INCOMPLETE_JOB = 'INCOMPLETE_JOB',
  UNASSIGNED_JOB = 'UNASSIGNED_JOB',
  CONTRACT_NOT_SIGNED = 'CONTRACT_NOT_SIGNED',
  PAYMENT_FAILED = 'PAYMENT_FAILED',
  DOCUMENT_REVIEW = 'DOCUMENT_REVIEW',
  QUALITY_ALERT = 'QUALITY_ALERT'
}

enum TaskPriority {
  CRITICAL = 'CRITICAL', // 2 hours SLA
  URGENT = 'URGENT',     // 4 hours SLA
  HIGH = 'HIGH',         // 8 hours SLA
  MEDIUM = 'MEDIUM',     // 16 hours SLA
  LOW = 'LOW'            // 40 hours SLA
}

enum TaskStatus {
  OPEN = 'OPEN',
  ASSIGNED = 'ASSIGNED',
  IN_PROGRESS = 'IN_PROGRESS',
  COMPLETED = 'COMPLETED',
  CANCELLED = 'CANCELLED'
}
```

### Database Schema (PostgreSQL)

```sql
CREATE TABLE tasks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  task_type VARCHAR(50) NOT NULL,
  priority VARCHAR(20) NOT NULL CHECK (priority IN ('CRITICAL', 'URGENT', 'HIGH', 'MEDIUM', 'LOW')),
  status VARCHAR(20) NOT NULL CHECK (status IN ('OPEN', 'ASSIGNED', 'IN_PROGRESS', 'COMPLETED', 'CANCELLED')),
  service_order_id UUID NOT NULL REFERENCES service_orders(id) ON DELETE CASCADE,
  context JSONB NOT NULL,

  -- Assignment
  assigned_to UUID REFERENCES users(id),
  assigned_by VARCHAR(100), -- User ID or 'SYSTEM'
  assigned_at TIMESTAMP,

  -- SLA Tracking
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  sla_deadline TIMESTAMP NOT NULL,
  sla_paused BOOLEAN DEFAULT FALSE,
  sla_paused_at TIMESTAMP,
  sla_pause_reason TEXT,
  total_paused_minutes INTEGER DEFAULT 0,

  -- Escalation
  escalation_level INTEGER DEFAULT 0 CHECK (escalation_level IN (0, 1, 2, 3)),
  escalated_at TIMESTAMP,

  -- Completion
  started_at TIMESTAMP,
  completed_at TIMESTAMP,
  completed_by UUID REFERENCES users(id),
  resolution_notes TEXT,
  resolution_time INTEGER, -- Minutes
  within_sla BOOLEAN,

  -- Cancellation
  cancelled_at TIMESTAMP,
  cancelled_by UUID REFERENCES users(id),
  cancellation_reason TEXT,

  -- Metadata
  country_code VARCHAR(2) NOT NULL,
  business_unit VARCHAR(10) NOT NULL
);

-- Indexes
CREATE INDEX idx_tasks_service_order ON tasks(service_order_id);
CREATE INDEX idx_tasks_assigned_to ON tasks(assigned_to);
CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_tasks_priority ON tasks(priority);
CREATE INDEX idx_tasks_sla_deadline ON tasks(sla_deadline);
CREATE INDEX idx_tasks_country ON tasks(country_code);
CREATE INDEX idx_tasks_type_status ON tasks(task_type, status);

-- Composite index for dashboard queries
CREATE INDEX idx_tasks_dashboard ON tasks(status, priority, sla_deadline, assigned_to);
```

### Task Audit Log Table

```sql
CREATE TABLE task_audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  task_id UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
  action VARCHAR(50) NOT NULL,
  performed_by VARCHAR(100) NOT NULL, -- User ID or 'SYSTEM'
  performed_at TIMESTAMP NOT NULL DEFAULT NOW(),
  changes JSONB, -- Before/after state
  notes TEXT
);

CREATE INDEX idx_task_audit_task_id ON task_audit_logs(task_id);
CREATE INDEX idx_task_audit_performed_at ON task_audit_logs(performed_at DESC);
```

---

## 12. API Contract

### Create Task

**Endpoint**: `POST /api/v1/tasks`

**Request**:
```json
{
  "taskType": "PRE_FLIGHT_FAILURE",
  "priority": "URGENT",
  "serviceOrderId": "so_abc123",
  "context": {
    "goExecutionStatus": "NOT_OK_PAYMENT",
    "paymentStatus": "NOT_PAID",
    "scheduledDate": "2025-01-20T09:00:00Z",
    "timeUntilAppointment": 6
  }
}
```

**Response** (201 Created):
```json
{
  "id": "task_xyz789",
  "taskType": "PRE_FLIGHT_FAILURE",
  "priority": "URGENT",
  "status": "ASSIGNED",
  "serviceOrderId": "so_abc123",
  "assignedTo": "op_456",
  "assignedBy": "SYSTEM",
  "assignedAt": "2025-01-20T03:00:00Z",
  "createdAt": "2025-01-20T03:00:00Z",
  "slaDeadline": "2025-01-20T07:00:00Z",
  "withinSLA": null
}
```

### Get Task by ID

**Endpoint**: `GET /api/v1/tasks/{taskId}`

**Response** (200 OK):
```json
{
  "id": "task_xyz789",
  "taskType": "PRE_FLIGHT_FAILURE",
  "priority": "URGENT",
  "status": "IN_PROGRESS",
  "serviceOrderId": "so_abc123",
  "context": { /* ... */ },
  "assignedTo": "op_456",
  "assignedBy": "SYSTEM",
  "assignedAt": "2025-01-20T03:00:00Z",
  "startedAt": "2025-01-20T03:15:00Z",
  "createdAt": "2025-01-20T03:00:00Z",
  "slaDeadline": "2025-01-20T07:00:00Z",
  "escalationLevel": 0,
  "withinSLA": null,
  "_links": {
    "self": "/api/v1/tasks/task_xyz789",
    "serviceOrder": "/api/v1/service-orders/so_abc123",
    "assignedOperator": "/api/v1/users/op_456"
  }
}
```

### List Tasks (with filters)

**Endpoint**: `GET /api/v1/tasks`

**Query Parameters**:
- `status` (optional): Filter by status (comma-separated)
- `priority` (optional): Filter by priority (comma-separated)
- `taskType` (optional): Filter by task type (comma-separated)
- `assignedTo` (optional): Filter by assigned operator
- `serviceOrderId` (optional): Filter by service order
- `countryCode` (optional): Filter by country
- `slaStatus` (optional): `on_track`, `at_risk`, `breached`
- `page` (default: 1)
- `pageSize` (default: 20, max: 100)
- `sortBy` (default: `slaDeadline`)
- `sortOrder` (default: `asc`)

**Example**: `GET /api/v1/tasks?status=OPEN,ASSIGNED&priority=URGENT,CRITICAL&sortBy=slaDeadline&sortOrder=asc`

**Response** (200 OK):
```json
{
  "data": [
    { /* task object */ },
    { /* task object */ }
  ],
  "pagination": {
    "page": 1,
    "pageSize": 20,
    "totalItems": 42,
    "totalPages": 3
  },
  "_links": {
    "self": "/api/v1/tasks?page=1",
    "next": "/api/v1/tasks?page=2",
    "last": "/api/v1/tasks?page=3"
  }
}
```

### Assign Task

**Endpoint**: `POST /api/v1/tasks/{taskId}/assign`

**Request**:
```json
{
  "assignedTo": "op_789"
}
```

**Response** (200 OK):
```json
{
  "id": "task_xyz789",
  "status": "ASSIGNED",
  "assignedTo": "op_789",
  "assignedBy": "op_456", // Current user
  "assignedAt": "2025-01-20T04:00:00Z"
}
```

### Start Task

**Endpoint**: `POST /api/v1/tasks/{taskId}/start`

**Response** (200 OK):
```json
{
  "id": "task_xyz789",
  "status": "IN_PROGRESS",
  "startedAt": "2025-01-20T04:05:00Z"
}
```

### Complete Task

**Endpoint**: `POST /api/v1/tasks/{taskId}/complete`

**Request**:
```json
{
  "resolutionNotes": "Contacted customer, payment confirmed. Manually overrode Go Execution check."
}
```

**Response** (200 OK):
```json
{
  "id": "task_xyz789",
  "status": "COMPLETED",
  "completedAt": "2025-01-20T04:30:00Z",
  "completedBy": "op_456",
  "resolutionNotes": "Contacted customer, payment confirmed. Manually overrode Go Execution check.",
  "resolutionTime": 90, // Minutes
  "withinSLA": true
}
```

### Cancel Task

**Endpoint**: `POST /api/v1/tasks/{taskId}/cancel`

**Request**:
```json
{
  "cancellationReason": "Service order was cancelled by customer"
}
```

**Response** (200 OK):
```json
{
  "id": "task_xyz789",
  "status": "CANCELLED",
  "cancelledAt": "2025-01-20T05:00:00Z",
  "cancelledBy": "op_456",
  "cancellationReason": "Service order was cancelled by customer"
}
```

### Pause/Resume SLA

**Endpoint**: `POST /api/v1/tasks/{taskId}/sla/pause`

**Request**:
```json
{
  "reason": "Waiting for customer to respond to email"
}
```

**Response** (200 OK):
```json
{
  "taskId": "task_xyz789",
  "slaPaused": true,
  "slaPausedAt": "2025-01-20T04:15:00Z",
  "slaPauseReason": "Waiting for customer to respond to email"
}
```

**Endpoint**: `POST /api/v1/tasks/{taskId}/sla/resume`

**Response** (200 OK):
```json
{
  "taskId": "task_xyz789",
  "slaPaused": false,
  "slaDeadline": "2025-01-20T07:30:00Z", // Extended by paused duration
  "totalPausedMinutes": 30
}
```

### Get Operator Dashboard

**Endpoint**: `GET /api/v1/tasks/dashboard`

**Response** (200 OK):
```json
{
  "myTasks": {
    "inProgress": [ /* tasks */ ],
    "assigned": [ /* tasks */ ],
    "total": 5
  },
  "upcomingSLAs": [ /* tasks with SLA < 4h */ ],
  "escalated": [ /* escalated tasks */ ],
  "recentlyCompleted": [ /* completed in last 24h */ ],
  "statistics": {
    "completedToday": 8,
    "averageResolutionTime": 45, // Minutes
    "slaComplianceRate": 92.5 // Percentage
  }
}
```

### Get Team Dashboard

**Endpoint**: `GET /api/v1/tasks/team-dashboard`

**Response** (200 OK):
```json
{
  "teamTasks": {
    "open": [ /* tasks */ ],
    "assigned": [ /* tasks */ ],
    "inProgress": [ /* tasks */ ],
    "total": 27
  },
  "tasksByOperator": [
    {
      "operatorId": "op_123",
      "operatorName": "Alice Operator",
      "activeTasks": 3,
      "slaBreaches": 0
    }
  ],
  "slaBreaches": [ /* tasks with SLA breach */ ],
  "escalatedTasks": [ /* escalated tasks */ ],
  "statistics": {
    "completedLast24h": 42,
    "averageResolutionTime": 52,
    "slaComplianceRate": 89.3,
    "tasksByType": [
      { "taskType": "PRE_FLIGHT_FAILURE", "count": 12 },
      { "taskType": "RESOLVE_WCF_RESERVES", "count": 8 }
    ]
  }
}
```

---

## 13. Event Schema

### Task Created Event

**Topic**: `tasks.task.created`

**Avro Schema**:
```json
{
  "type": "record",
  "name": "TaskCreated",
  "namespace": "com.ahs.fsm.events.tasks",
  "fields": [
    { "name": "event_id", "type": "string" },
    { "name": "event_timestamp", "type": { "type": "long", "logicalType": "timestamp-millis" } },
    { "name": "task_id", "type": "string" },
    { "name": "task_type", "type": { "type": "enum", "symbols": ["PRE_FLIGHT_FAILURE", "RESOLVE_WCF_RESERVES", "WCF_NOT_SIGNED", "INVOICE_CONTESTED", "INCOMPLETE_JOB", "UNASSIGNED_JOB", "CONTRACT_NOT_SIGNED", "PAYMENT_FAILED", "DOCUMENT_REVIEW", "QUALITY_ALERT"] } },
    { "name": "priority", "type": { "type": "enum", "symbols": ["CRITICAL", "URGENT", "HIGH", "MEDIUM", "LOW"] } },
    { "name": "service_order_id", "type": "string" },
    { "name": "context", "type": "string" }, // JSON string
    { "name": "sla_deadline", "type": { "type": "long", "logicalType": "timestamp-millis" } },
    { "name": "country_code", "type": "string" },
    { "name": "business_unit", "type": "string" }
  ]
}
```

### Task Assigned Event

**Topic**: `tasks.task.assigned`

**Avro Schema**:
```json
{
  "type": "record",
  "name": "TaskAssigned",
  "namespace": "com.ahs.fsm.events.tasks",
  "fields": [
    { "name": "event_id", "type": "string" },
    { "name": "event_timestamp", "type": { "type": "long", "logicalType": "timestamp-millis" } },
    { "name": "task_id", "type": "string" },
    { "name": "assigned_to", "type": "string" },
    { "name": "assigned_by", "type": "string" },
    { "name": "assigned_at", "type": { "type": "long", "logicalType": "timestamp-millis" } }
  ]
}
```

### Task Completed Event

**Topic**: `tasks.task.completed`

**Avro Schema**:
```json
{
  "type": "record",
  "name": "TaskCompleted",
  "namespace": "com.ahs.fsm.events.tasks",
  "fields": [
    { "name": "event_id", "type": "string" },
    { "name": "event_timestamp", "type": { "type": "long", "logicalType": "timestamp-millis" } },
    { "name": "task_id", "type": "string" },
    { "name": "task_type", "type": { "type": "enum", "symbols": ["PRE_FLIGHT_FAILURE", "RESOLVE_WCF_RESERVES", "WCF_NOT_SIGNED", "INVOICE_CONTESTED", "INCOMPLETE_JOB", "UNASSIGNED_JOB", "CONTRACT_NOT_SIGNED", "PAYMENT_FAILED", "DOCUMENT_REVIEW", "QUALITY_ALERT"] } },
    { "name": "completed_by", "type": "string" },
    { "name": "completed_at", "type": { "type": "long", "logicalType": "timestamp-millis" } },
    { "name": "resolution_time_minutes", "type": "int" },
    { "name": "within_sla", "type": "boolean" },
    { "name": "service_order_id", "type": "string" }
  ]
}
```

### Task Escalated Event

**Topic**: `tasks.task.escalated`

**Avro Schema**:
```json
{
  "type": "record",
  "name": "TaskEscalated",
  "namespace": "com.ahs.fsm.events.tasks",
  "fields": [
    { "name": "event_id", "type": "string" },
    { "name": "event_timestamp", "type": { "type": "long", "logicalType": "timestamp-millis" } },
    { "name": "task_id", "type": "string" },
    { "name": "escalation_level", "type": "int" },
    { "name": "escalation_reason", "type": { "type": "enum", "symbols": ["SLA_BREACH", "MANUAL"] } },
    { "name": "notified_users", "type": { "type": "array", "items": "string" } }
  ]
}
```

---

## 14. NFRs & Quality Attributes

### Performance

**NFR-TASK-001**: Task dashboard loads in < 1 second for up to 100 tasks

**NFR-TASK-002**: Task creation and assignment completes in < 500ms

**NFR-TASK-003**: SLA escalation checks run every 5 minutes with < 1 second execution time

### Scalability

**NFR-TASK-004**: System supports up to 10,000 active tasks concurrently

**NFR-TASK-005**: System supports up to 500 concurrent operators viewing dashboards

### Reliability

**NFR-TASK-006**: Task creation has 99.9% success rate (no lost tasks)

**NFR-TASK-007**: SLA escalation notifications have 99.5% delivery rate

### Usability

**NFR-TASK-008**: Operators can find and open a task in < 3 clicks from dashboard

**NFR-TASK-009**: Task context provides all necessary information to resolve task without navigating away (single-page task view)

### Audit & Compliance

**NFR-TASK-010**: All task state changes are logged to audit trail with user ID and timestamp

**NFR-TASK-011**: Task audit logs are retained for 7 years for compliance

---

## 15. Security & RBAC

### Permissions

**Permission**: `tasks:view`
**Description**: View tasks assigned to self or team
**Roles**: SERVICE_OPERATOR, SENIOR_OPERATOR, TEAM_LEAD, MANAGER

**Permission**: `tasks:view:all`
**Description**: View all tasks across all teams
**Roles**: ADMIN, SENIOR_MANAGEMENT

**Permission**: `tasks:create`
**Description**: Manually create tasks
**Roles**: SERVICE_OPERATOR, SENIOR_OPERATOR, TEAM_LEAD, MANAGER

**Permission**: `tasks:assign`
**Description**: Assign tasks to operators
**Roles**: TEAM_LEAD, MANAGER

**Permission**: `tasks:assign:self`
**Description**: Self-assign tasks from task pool
**Roles**: SERVICE_OPERATOR, SENIOR_OPERATOR

**Permission**: `tasks:update`
**Description**: Update task details (notes, priority, etc.)
**Roles**: SERVICE_OPERATOR (own tasks), TEAM_LEAD (team tasks), MANAGER

**Permission**: `tasks:complete`
**Description**: Mark tasks as completed
**Roles**: SERVICE_OPERATOR (own tasks), TEAM_LEAD (team tasks), MANAGER

**Permission**: `tasks:cancel`
**Description**: Cancel tasks
**Roles**: TEAM_LEAD, MANAGER

**Permission**: `tasks:escalate`
**Description**: Manually escalate tasks
**Roles**: TEAM_LEAD, MANAGER

**Permission**: `tasks:override_sla`
**Description**: Pause/resume SLA, extend deadlines
**Roles**: MANAGER, ADMIN

### Authorization Logic

```typescript
async function authorizeTaskAccess(
  userId: string,
  taskId: string,
  action: 'view' | 'update' | 'complete' | 'cancel'
): Promise<boolean> {
  const user = await userRepository.findById(userId);
  const task = await taskRepository.findById(taskId);

  // Check global permissions
  if (user.permissions.includes(`tasks:${action}:all`)) {
    return true;
  }

  // Check if user owns the task
  if (action === 'view' || action === 'update' || action === 'complete') {
    if (task.assignedTo === userId && user.permissions.includes(`tasks:${action}`)) {
      return true;
    }
  }

  // Check if user is manager of assigned operator
  if (action === 'view' || action === 'update' || action === 'complete' || action === 'cancel') {
    const assignedOperator = await userRepository.findById(task.assignedTo);
    if (assignedOperator.managerId === userId && user.permissions.includes(`tasks:${action}`)) {
      return true;
    }
  }

  // Check tenant isolation (country/BU match)
  if (user.permissions.includes(`tasks:${action}`)) {
    const hasCountryAccess = user.managedCountries.includes(task.countryCode);
    const hasBUAccess = user.managedBusinessUnits.includes(task.businessUnit);
    if (hasCountryAccess && hasBUAccess) {
      return true;
    }
  }

  return false;
}
```

---

## 16. Open Questions

**Q1**: What is the minimum completion percentage required for service order checklists?
**Status**: Pending clarification from product team
**Impact**: Affects INCOMPLETE_JOB task creation trigger

**Q2**: Should SLA clock pause outside business hours for non-CRITICAL tasks?
**Status**: Pending decision
**Impact**: Affects SLA deadline calculation and escalation timing

**Q3**: What is the escalation hierarchy for different operator roles (e.g., SERVICE_OPERATOR → SENIOR_OPERATOR → TEAM_LEAD → MANAGER)?
**Status**: Pending organizational structure definition
**Impact**: Affects automatic reassignment on escalation

**Q4**: Should tasks be automatically created for all service orders with CSAT < 3.0, or only when customer provides negative feedback?
**Status**: Pending quality team input
**Impact**: Affects QUALITY_ALERT task volume

**Q5**: What actions should trigger automatic task cancellation (beyond service order cancellation)?
**Status**: Pending business rules definition
**Impact**: Affects task lifecycle management

---

## Document Control

**Version History**:

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-01-16 | Engineering Team | Initial draft |

**Approvals**:

- [ ] Product Owner
- [ ] Engineering Lead
- [ ] Quality Manager
- [ ] Operations Manager

**Next Review Date**: 2025-02-16

---

**End of Document**
